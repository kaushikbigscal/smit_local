<?xml version="1.0" encoding="UTF-8" ?>

<odoo>
    <record model="ir.ui.view" id="crm_salesperson_planner_visit_tree_view">
        <field name="name">CRM - Salesperson Planner Visit Tree</field>
        <field name="model">crm.salesperson.planner.visit</field>
        <field name="arch" type="xml">
            <tree
                    decoration-success="state == 'done'"
                    decoration-info="state == 'confirm'"
                    decoration-warning="state == 'incident'"
                    decoration-muted="state == 'cancel'"
            >
                <field name="name" readonly="1"/>
                <field name="sequence"/>
<!--                <field name="date"/>-->
                 <field name="date_start" string="Planned Date" widget="daterange" options="{'end_date_field': 'date', 'always_range': '1'}" optional="hide"/>
                    <field name="date" column_invisible="True" />
                <field name="partner_id"/>
                <field name="user_id"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <field name="state" readonly="1"/>
                <field name="visit_objective" widget="many2many_tags" options="{'color_field': 'color'}" optional="hide"/>
                <button
                        name="action_draft"
                        type="object"
                        invisible="state not in ['cancel','incident', 'done']"
                        icon="fa-undo"
                />
                <button
                        name="action_confirm"
                        type="object"
                        icon="fa-calendar text-success"
                        invisible="state != 'draft'"
                />
                <button
                        name="action_done"
                        type="object"
                        icon="fa-check"
                        invisible="state != 'confirm'"
                />
                <button
                        name="%(crm_salesperson_planner_visit_close_wiz_action)d"
                        type="action"
                        icon="fa-ban text-danger"
                        invisible="state in ['cancel','incident', 'done']"
                        context="{'att_close_type':'cancel'}"
                        title="Close Reasons"
                />
                <button
                        name="%(crm_salesperson_planner_visit_close_wiz_action)d"
                        type="action"
                        icon="fa-exclamation-triangle"
                        invisible="state != 'confirm'"
                        context="{'att_close_type':'incident'}"
                        title="Close Reasons"
                />
                <field name="show_time_control" column_invisible="True"/>


                <button
                        name="button_start_work"
                        string="Start Work"
                        tabindex="-1"
                        type="object"
                        icon="fa-play-circle text-success"
                        invisible="show_time_control != 'start'"
                        class="oe_stat_button"
                        title="Start work"
                />

                <button
                        name="button_end_work"
                        string="Stop Work"
                        tabindex="-1"
                        type="object"
                        icon="fa-stop-circle text-warning"
                        invisible="show_time_control != 'stop'"
                        class="oe_stat_button"
                        title="End work"
                />


            </tree>
        </field>
    </record>
    <record model="ir.ui.view" id="crm_salesperson_planner_visit_form_view">
        <field name="name">CRM - Salesperson Planner Visit Form</field>
        <field name="model">crm.salesperson.planner.visit</field>
        <field name="arch" type="xml">
            <form string="Visit">
                <header>
                    <button
                            name="action_draft"
                            id="action_draft"
                            string="Draft"
                            type="object"
                            invisible="state not in ['cancel','incident', 'done']"
                    />
                    <button
                            name="action_confirm"
                            id="action_confirm"
                            string="Confirm"
                            class="btn-primary"
                            type="object"
                            invisible="state != 'draft'"
                    />
                    <button
                            name="action_done"
                            id="action_done"
                            string="Done"
                            class="btn-primary"
                            type="object"
                            invisible="state != 'confirm'"
                    />
                    <button
                            name="%(crm_salesperson_planner_visit_close_wiz_action)d"
                            id="action_cancel"
                            string="Cancel"
                            type="action"
                            invisible="state in ['cancel','incident', 'done']"
                            context="{'att_close_type':'cancel'}"
                    />
                    <button
                            name="%(crm_salesperson_planner_visit_close_wiz_action)d"
                            id="action_incident"
                            string="Incident"
                            type="action"
                            invisible="state != 'confirm'"
                            context="{'att_close_type':'incident'}"
                    />
                    <field
                            name="state"
                            widget="statusbar"
                            statusbar_visible="draft,confirm,done,cancel"
                            readonly="1"
                    />
                </header>

                <sheet string="Visit">
                    <div class="oe_button_box" name="button_box">
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field
                                    name="partner_id"
                                    widget="res_partner_many2one"
                                    context="{'res_partner_search_mode': 'customer', 'show_address': True, 'show_vat': True}"
                                    options="{&quot;always_reload&quot;: True}"
                            />
                            <field
                                    name="partner_phone"
                                    widget="phone"
                                    invisible="not partner_id"
                            />
                            <field
                                    name="partner_mobile"
                                    widget="phone"
                                    invisible="not partner_id"
                            />
                            <field name="visit_objective" widget="many2many_tags" options="{'color_field': 'color'}"/>
                        </group>
                        <group>
                            <field name="date_start" string="Planned Date" widget="daterange" options='{"end_date_field": "date", "always_range": "1"}' required="date_start or date" />
                            <field name="date" invisible="1" required="date_start"/>
                            <field name="is_work_started" invisible="1"/>

                            <field name="calendar_event_id" readonly="1"/>
                            <field name="sequence"/>
                            <field name="user_id"/>
                            <field
                                    name="company_id"
                                    groups="base.group_multi_company"
                            />
                        </group>
                    </group>
                    <notebook>
                        <page
                                string="Close Info"
                                invisible="state not in ['cancel', 'incident']"
                        >
                            <group>
                                <field
                                        name="close_reason_id"
                                        readonly="1"
                                        options="{'no_edit': True, 'no_open': True}"
                                />
                                <field name="close_reason_notes" readonly="1"/>
                                <field
                                        name="close_reason_image"
                                        widget="image"
                                        readonly="1"
                                        invisible="not close_reason_image"
                                />
                            </group>
                        </page>
                        <page string="Internal Notes">
                            <field
                                    name="description"
                                    placeholder="Add a description..."
                            />
                        </page>
                        <page string="Timesheets">
                            <field name="timesheet_ids">
                                <tree>
                                    <field name="start_time"/>
                                    <field name="end_time"/>
                                    <field name="total_working_time"/>
                                </tree>
                            </field>
                        </page>
                        <!--                        <page string="Opportunities">-->
                        <!--                                <field-->
                        <!--                                name="opportunity_ids"-->
                        <!--                                nolabel="1"-->
                        <!--                                options="{'no_create': True}"-->
                        <!--                            />-->
                        <!--                        </page>-->
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field
                            name="message_follower_ids"
                            widget="mail_followers"
                            groups="base.group_user"
                    />
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>


    <record model="ir.ui.view" id="crm_salesperson_planner_visit_calendar_view">
        <field name="name">CRM - Salesperson Planner Visit Calendar</field>
        <field name="model">crm.salesperson.planner.visit</field>
        <field name="arch" type="xml">
            <calendar  string="Visit" date_start="date_start" date_stop="date"
                event_open_popup="true"
                event_limit="5"
                quick_create="true"
                color="user_id"
                quick_create_view_id="%(tour_plan.crm_salesperson_planner_visit_form_view)d"
            >
                        <field name="name"/>
                                <field name="partner_id"/>
                                <field name="user_id"/>
                <field name="visit_objective" widget="many2many_tags" options="{'color_field': 'color'}" invisible="not visit_objective"/>
            </calendar>
        </field>
    </record>




    <record id="tour_plan_view_activity" model="ir.ui.view">
        <field name="name">tour.plan.activity</field>
        <field name="model">crm.salesperson.planner.visit</field>
        <field name="arch" type="xml">
            <activity string="Visit">
                <field name="id"/>
                <templates>
                    <div t-name="activity-box">
                        <img class="rounded"
                             t-att-src="activity_image('crm.salesperson.planner.visit', 'avatar_128', record.id.raw_value)"
                             role="img" t-att-title="record.id.value" t-att-alt="record.id.value"/>
                        <div class="d-flex justify-content-start gap-5">
                            <field name="name" display="full" class="o_text_block"/>
                            <field name="user_id" widget="many2one_avatar_user"/>

                        </div>
                    </div>
                </templates>
            </activity>
        </field>
    </record>

    <record id="crm_salesperson_planner_visit_filter" model="ir.ui.view">
        <field name="name">CRM - Salesperson Planner Visit Search</field>
        <field name="model">crm.salesperson.planner.visit</field>
        <field name="arch" type="xml">
            <search string="Search Visits">
                <field name="name" readonly="1"/>
                <field
                        name="partner_id"
                        filter_domain="[('partner_id','child_of',self)]"
                />
                <field name="user_id"/>
                 <filter string="Start Date" name="start_date" date="date_start"/>
                <filter string="End Date" name="end_date" date="date"/>
                <!--                <field name="opportunity_ids" />-->
                <field name="visit_objective"/>
                <separator/>
                <filter
                        string="My Visits"
                        name="assigned_to_me"
                        domain="[('user_id', '=', uid)]"
                        help="Visits that are assigned to me"
                />
                <separator orientation="vertical"/>
                <filter
                        string="Late Visits"
                        name="visits_overdue"
                        domain="[('date', '&lt;', context_today().strftime('%Y-%m-%d'))]"
                />
                <filter
                        string="Today Visits"
                        name="visits_today"
                        domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"
                />
                <filter
                        string="Future Visits"
                        name="visits_upcoming_all"
                        domain="[('date', '&gt;', context_today().strftime('%Y-%m-%d'))]"
                />
                <group expand="0" name="visits" string="Group By">
                    <filter
                            string="Salesperson"
                            name="salesperson"
                            context="{'group_by': 'user_id'}"
                    />
                    <filter
                            string="Partner"
                            name="partner"
                            context="{'group_by': 'partner_id'}"
                    />
                    <filter
                            string="State"
                            name="state"
                            context="{'group_by': 'state'}"
                    />
                    <filter
                            string="Company"
                            name="company"
                            context="{'group_by':'company_id'}"
                            groups="base.group_multi_company"
                    />
                    <separator orientation="vertical"/>
                    <filter
                            string="Visit by Date"
                            context="{'group_by':'date'}"
                            name="date"
                    />
                    <filter string="Visit Objective" name="objective" context="{'group_by': 'visit_objective'}"/>
                </group>
            </search>
        </field>
    </record>
    <record model="ir.actions.act_window" id="my_crm_salesperson_planner_visit_action">
        <field name="name">Visits</field>
        <field name="res_model">crm.salesperson.planner.visit</field>
        <field name="view_mode">calendar,tree,form,pivot,activity</field>
        <field name="context">{
            'search_default_visits_today':1,
            }
        </field>
        <field name="domain">[('user_id', '=', uid)]</field>
        <field
                name="search_view_id"
                ref="tour_plan.crm_salesperson_planner_visit_filter"
        />
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Record and Track Your Visits.
            </p>
        </field>
    </record>
    <record model="ir.actions.act_window" id="all_crm_salesperson_planner_visit_action">
        <field name="name">Visits</field>
        <field name="res_model">crm.salesperson.planner.visit</field>
        <field name="view_mode">calendar,tree,form,pivot,activity</field>
        <field name="context">{
            'search_default_salesperson':1,
            }
        </field>
        <field
                name="search_view_id"
                ref="tour_plan.crm_salesperson_planner_visit_filter"
        />
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Record and Track All Visits.
            </p>
        </field>
    </record>
</odoo>
