<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <template id="custom_portal_layout_cards" inherit_id="portal.portal_layout">
        <xpath expr="//div[contains(@class, 'wrapper') and contains(@class, 'd-flex')]" position="before">
            <t t-set="open_ticket_count" t-value="request.env['project.task'].sudo().search_count([
               ('is_fsm', '=', True),
               ('partner_id', '=', request.env.user.partner_id.id),
               ('stage_id.name', 'not in', ['Done', 'Cancelled', 'Resolved'])
            ])"/>
            <div class="container-fluid my-3">
                <!-- Card -->
                <div class="card welcome-card">  <!-- Add mb-4 -->
                    <div class="d-flex align-items-center justify-content-between welcome-banner">
                        <div class="welcome-message">
                            <h5 class="mb-2">
                                <span id="welcome-text" class="slide-text"></span>
                            </h5>
                            <t t-if="fsm_installed">
                                <p class="mb-0">
                                    <a href="/my/active/assets">
                                        <t t-esc="active_asset_count or 0"/>
                                    </a>
                                    active assets and
                                    <a href="/my/open/ticket">
                                        <t t-esc="open_ticket_count or 0"/>
                                    </a>
                                    open tickets
                                </p>
                            </t>
                        </div>
                        <!-- Right: Notification Icon -->
                        <t t-set="unread_notification_count"
                           t-value="request.env['portal.notification'].sudo().search_count([
                                   ('partner_id', '=', request.env.user.partner_id.id),
                                   ('is_read', '=', False)])"/>
                        <div class="notification-icon position-relative" style="display: inline-block;">
                            <a href="/my/notifications" class="position-relative" style="display: inline-block;">
                                <i class="fa fa-bell" style="color: #f5f7fa; font-size: 20px;"></i>
                                <t t-if="unread_notification_count">
                                    <span style="
                                                position: absolute;
                                                top: -5px;
                                                right: -8px;
                                                background-color: #28a745;
                                                color: white;
                                                font-size: 0.70rem;
                                                font-weight: bold;
                                                border-radius: 50%;
                                                padding: 3px 6px;
                                                line-height: 1;
                                                min-width: 18px;
                                                text-align: center;
                                                ">
                                            <t t-esc="unread_notification_count"/>
                                    </span>
                                </t>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function () {
                    const texts = ["Welcome Back!", "Glad to see you!", "Have a productive day!"];
                    let index = 0;
                    const element = document.getElementById('welcome-text');

                    function showMessage(text) {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'slide-text';
                        newSpan.innerText = text;

                        const oldSpan = document.getElementById('welcome-text');
                        oldSpan.parentNode.replaceChild(newSpan, oldSpan);
                        newSpan.id = 'welcome-text';
                    }

                    showMessage(texts[index]);

                    setInterval(() => {
                        index = (index + 1) % texts.length;
                        showMessage(texts[index]);
                    }, 2000);
                });
            </script>
            <div class="d-flex justify-content-center">
                <t t-if="company.image">
                    <!-- Carousel -->
                    <div id="carouselExampleControls" class="carousel slide carousel-fade w-100"
                         data-bs-ride="carousel" data-bs-interval="3000" style="max-width: 100%;">
                        <div class="carousel-inner rounded shadow bg-light">
                            <t t-set="index" t-value="0"/>
                            <t t-foreach="company.image" t-as="banner">
                                <div t-attf-class="carousel-item #{'active' if index == 0 else ''}">
                                    <img t-att-src="'/web/image/ir.attachment/%s/datas' % banner.id"
                                         class="d-block w-100 rounded mx-auto"
                                         t-att-alt="banner.name or 'Banner Image'"
                                         style="aspect-ratio: 3 / 1; width: 100%; max-width: 100%; object-fit: fill; background-color: #f8f9fa;"/>
                                </div>
                                <t t-set="index" t-value="index + 1"/>
                            </t>
                        </div>

                        <!-- Desktop Arrows -->
                        <button class="carousel-control-prev d-none d-md-flex" type="button"
                                data-bs-target="#carouselExampleControls"
                                data-bs-slide="prev" style="top: 50%; transform: translateY(-50%);">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next d-none d-md-flex" type="button"
                                data-bs-target="#carouselExampleControls"
                                data-bs-slide="next" style="top: 50%; transform: translateY(-50%);">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>

                        <!-- Mobile Arrows -->
                        <button class="carousel-control-prev d-flex d-md-none" type="button"
                                data-bs-target="#carouselExampleControls"
                                data-bs-slide="prev" style="top: 50%; transform: translateY(-50%); z-index: 10;">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next d-flex d-md-none" type="button"
                                data-bs-target="#carouselExampleControls"
                                data-bs-slide="next" style="top: 50%; transform: translateY(-50%); z-index: 10;">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </t>
            </div>

            <div class="info-card-grid w-100 mb-4">
                <!-- Active Assets Card -->
                <t t-if="fsm_installed">
                    <a t-attf-href="/my/active/assets" class="text-decoration-none">
                        <div class="info-card">
                            <div class="info-card-title">Active Assets</div>
                            <div class="info-card-value">
                                    <t t-esc="active_asset_count or 0"/>
                            </div>
                            <div class="info-icon">
                                <i class="bi bi-box2"></i>
                            </div>
                            <div t-attf-class="info-card-status #{'info-green' if under_service_count == 0 else 'info-red'}">
                                <t t-if="active_asset_count == 0">
                                    No assets
                                </t>
                                <t t-elif="under_service_count == 0">
                                    All Operational
                                </t>
                                <t t-else="">
                                    <t t-esc="under_service_count"/>
                                    Under Service
                                </t>
                            </div>
                        </div>
                    </a>
                </t>
                <t t-if="fsm_installed">
                    <a t-attf-href="/my/open/ticket" class="text-decoration-none">
                        <div class="info-card">
                            <div class="info-card-title">Open Tickets</div>

                            <!-- Count -->
                            <div class="info-card-value">
                                <t t-esc="open_ticket_count or 0"/>
                            </div>
                            <div class="info-icon">
                                <i class="bi bi-chat-left"></i>
                            </div>

                            <!-- Status: green if 0, red if >0 -->
                            <div t-attf-class="info-card-status #{'info-green' if open_ticket_count == 0 else 'info-red'}">
                                <t t-if="open_ticket_count == 0">No Open tickets</t>
                                <t t-else="">
                                    <t t-esc="open_ticket_count or 0"/>
                                    Pending
                                </t>
                            </div>
                        </div>
                    </a>
                </t>

                <!-- Quotations Card -->
                <div t-att-class="'info-card ' + ('full-width-mobile' if not (fsm_installed and contract_count > 0) else '')">
                    <a t-attf-href="/my/quotes" class="text-decoration-none">
                        <div class="info-card-title">Quotations</div>
                        <div class="info-card-value">
                            <t t-esc="quotation_count or 0"/>
                        </div>
                        <div class="info-icon">
                            <i class="bi bi-file-earmark-richtext"></i>
                        </div>
                        <div t-attf-class="info-card-status #{'info-green' if quotation_count == 0 else 'info-red'}">
                            <t t-if="quotation_count == 0">No pending reviews</t>
                            <t t-else="">
                                <t t-esc="quotation_count or 0"/>
                                Pending for reviews
                            </t>
                        </div>
                    </a>
                </div>

                <t t-if="fsm_installed and contract_count > 0">
                    <a href="/my/contract/list" style="text-decoration: none;">
                        <div class="info-card">
                            <div class="info-card-title">Contract Status</div>

                            <!-- Status text: Expired or Active -->
                            <div class="info-card-value">
                                <t t-if="is_expired">Expired</t>
                                <t t-elif="contract_count == 1">Active</t>
                                <t t-else="">
                                    <t t-esc="contract_count"/>
                                </t>
                            </div>
                            <div class="info-icon">
                                <t t-if="is_expired">
                                    <i class="bi bi-x-circle"></i>
                                </t>
                                <t t-else="">
                                    <i class="bi bi-check2-circle"></i>
                                </t>
                            </div>

                            <!-- Status message below: Red if expired -->
                            <t t-if="contract_count == 1 and contract_renewal_message">
                                <div t-attf-class="info-card-status #{'info-red' if is_expired else 'info-green'}">
                                    <t t-esc="contract_renewal_message"/>
                                </div>
                            </t>
                        </div>
                    </a>
                </t>
            </div>

            <t t-if="fsm_installed">
                <div class="row mb-4">
                    <!-- Card 1: Your Assets -->
                    <div class="col-md-6 mb-4">
                        <div class="card p-2 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="section-title">My Assets</span>
                                <a href="/my/assets" class="view-all-link small">
                                    <i class="fa fa-eye me-1"></i>
                                    View All →
                                </a>
                            </div>
                            <div class="vstack gap-2">
                                <t t-if="mappings">
                                    <t t-foreach="mappings" t-as="mapping">
                                        <a t-attf-href="/my/asset/#{mapping.id}"
                                           class="border p-2 d-flex align-items-center text-decoration-none card-bg">
                                            <img t-att-src="mapping.product_id.image_128 and ('data:image/png;base64,' + mapping.product_id.image_128.decode('utf-8'))"
                                                 class="me-3"
                                                 style="width: 40px; height: 40px; object-fit: cover;"/>
                                            <div>
                                                <div class="card-title" t-esc="mapping.product_id.name"/>
                                                <div class="card-subtitle"
                                                     t-esc="mapping.unique_number or 'No Unique Number'"/>
                                            </div>

                                        </a>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="card-subtitle">No Assets Available.</div>
                                </t>
                            </div>
                        </div>
                    </div>
                    <!-- Card 2: My Contract -->
                    <div class="col-md-6 mb-4">
                        <div class="card p-2 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="section-title">My Contract</span>
                                <a href="/my/contract/list" class="view-all-link small">
                                    <i class="fa fa-eye me-1"></i>
                                    View All →
                                </a>
                            </div>
                            <div class="vstack gap-2">
                                <t t-if="my_contract">
                                    <t t-foreach="my_contract" t-as="contract">
                                        <a t-attf-href="/my/contract/form/#{contract.id}"
                                           class="border p-2 d-flex align-items-center text-decoration-none card-bg">
                                            <div>
                                                <div class="card-title" t-esc="contract.name"/>
                                                <div class="card-subtitle"
                                                     t-esc="contract.contract_type.name or 'No Contract Type'"/>
                                            </div>
                                        </a>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="card-subtitle">No Contract Available.</div>
                                </t>
                            </div>
                        </div>
                    </div>

                    <!-- Card 3: Quotations -->
                    <div class="col-md-6 mb-4">
                        <div class="card p-2 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="section-title">Quotations</span>
                                <a href="/my/quotes" class="view-all-link small">
                                    <i class="fa fa-eye me-1"></i>
                                    View All →
                                </a>
                            </div>
                            <div class="vstack gap-2">
                                <t t-if="quotation">
                                    <t t-foreach="quotation" t-as="quotes">
                                        <a t-attf-href="/my/quotations/#{quotes.id}?access_token=#{quotes.access_token}"
                                           class="border p-2 d-flex align-items-center text-decoration-none card-bg">
                                            <div>
                                                <div class="card-title" t-esc="quotes.name"/>
                                            </div>
                                        </a>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="card-subtitle">No Quotations Available.</div>
                                </t>
                            </div>
                        </div>
                    </div>

                    <!-- Card 4: Tickets -->
                    <div class="col-md-6 mb-4">
                        <div class="card p-2 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                                <span class="section-title">Tickets</span>
                                <div class="d-flex align-items-center flex-wrap">
                                    <t t-if="mappings">
                                        <!-- Normal size on desktop, small on mobile -->
                                        <a href="/my/ticket/create"
                                           class="btn btn-primary btn-sm btn-md me-2">
                                            Create Ticket
                                        </a>
                                    </t>
                                    <t t-if="enable_scanner">
                                        <!-- Scan button -->
                                        <button type="button"
                                                class="btn btn-secondary btn-sm btn-md me-2"
                                                id="scan_btn">
                                            <i class="fa fa-qrcode me-2"></i>
                                            Scan QR/Barcode
                                        </button>
                                        <input type="hidden" id="scanned_code" name="scanned_code"/>
                                    </t>

                                    <!-- View all link -->
                                    <a href="/my/view"
                                       class="view-all-link small d-block d-md-inline mt-2 mt-md-0">
                                        <i class="fa fa-eye me-1"></i>
                                        View All →
                                    </a>
                                </div>
                            </div>
                            <div class="vstack gap-2">
                                <t t-if="assigned_calls">
                                    <t t-foreach="assigned_calls" t-as="call">
                                        <a t-attf-href="/my/ticket/#{call.id}"
                                           class="border p-2 d-flex align-items-center justify-content-between text-decoration-none card-bg">
                                            <div>
                                                <div class="card-title" t-esc="call.name"/>
                                                <div class="card-subtitle"
                                                     t-esc="call.sequence_fsm or 'No Sequence'"/>
                                            </div>
                                            <div>
                                                <span class="badge rounded-pill"
                                                      t-esc="call.stage_id.name or 'N/A'"
                                                      title="Current stage of this ticket"/>
                                            </div>
                                        </a>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="card-subtitle">No Ticket Available.</div>
                                </t>
                            </div>
                        </div>
                    </div>
                    <div id="scanner-modal"
                         style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                                            background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
                        <div style="position:relative; width:90%; max-width:500px; background:#fff; border-radius:8px; padding:10px;">
                            <div id="reader" style="width:100%; height:400px;"></div>
                            <button type="button"
                                    id="close_scan_btn"
                                    class="btn btn-danger"
                                    style="position:absolute; top:10px; right:10px; z-index:10;">
                                ✕
                            </button>
                        </div>
                    </div>
                    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const scanBtn = document.getElementById("scan_btn");
                            const scannedInput = document.getElementById("scanned_code");
                            const scannerModal = document.getElementById("scanner-modal");
                            const readerDiv = document.getElementById("reader");
                            const closeBtn = document.getElementById("close_scan_btn");

                            let html5QrCode;

                            // Function to check if a camera is attached
                            async function isCameraAvailable() {
                                try {
                                    const devices = await navigator.mediaDevices.enumerateDevices();
                                    const videoDevices = devices.filter(device => device.kind === "videoinput");
                                    return videoDevices.length > 0;
                                } catch (err) {
                                    console.error("Error checking camera devices", err);
                                    return false;
                                }
                            }

                            // Open scanner on button click
                            scanBtn.addEventListener("click", async function () {
                                const cameraAvailable = await isCameraAvailable();
                                if (!cameraAvailable) {
                                    alert("No camera detected! Please attach a camera before scanning.");
                                    return; // Stop execution if no camera
                                }

                                scannerModal.style.display = "flex"; // show fullscreen modal

                                if (!html5QrCode) {
                                    html5QrCode = new Html5Qrcode("reader");
                                }

                                html5QrCode.start(
                                    { facingMode: "environment" },
                                    {
                                        fps: 10,
                                        qrbox: { width: 250, height: 250 },
                                        formatsToSupport: [
                                            Html5QrcodeSupportedFormats.QR_CODE,
                                            Html5QrcodeSupportedFormats.CODE_128
                                        ]
                                    },
                                    qrCodeMessage => {
                                        scannedInput.value = qrCodeMessage;
                                        alert("Scanned: " + qrCodeMessage);

                                        // Redirect user
                                        window.location.href = qrCodeMessage;

                                        html5QrCode.stop().then(() => {
                                            scannerModal.style.display = "none";
                                        });
                                    },
                                    errorMessage => {
                                        console.log("Scanning...", errorMessage);
                                    }
                                ).catch(err => {
                                    alert("Camera error: " + err);
                                    console.error("Unable to start scanning", err);
                                    scannerModal.style.display = "none";
                                });
                            });

                            // Close scanner on button click
                            closeBtn.addEventListener("click", function () {
                                if (html5QrCode) {
                                    html5QrCode.stop().then(() => {
                                        scannerModal.style.display = "none";
                                    }).catch(err => {
                                        console.error("Stop failed", err);
                                        scannerModal.style.display = "none";
                                    });
                                } else {
                                    scannerModal.style.display = "none";
                                }
                            });
                        });
                    </script>
                </div>
            </t>
            <t t-if="featured_products_slider">
                <div class="container-fluid mb-5">
                    <h4 class="text-center mb-4">Featured Products</h4>
                    <div class="mx-auto" style="max-width: 1100px;">
                        <!-- Desktop Carousel -->
                        <div class="d-none d-md-block">
                            <div id="featuredCarouselDesktop"
                                 class="carousel slide"
                                 data-bs-ride="carousel"
                                 data-bs-interval="2000"
                                 data-bs-pause="hover">
                                <div class="carousel-inner">
                                    <t t-set="desktop_chunks"
                                       t-value="[featured_products_slider[i:i+4] for i in range(0, len(featured_products_slider), 4)]"/>
                                    <t t-foreach="desktop_chunks" t-as="chunk" t-foreach-index="chunk_index">
                                        <div t-att-class="'carousel-item' + (' active' if chunk_index == 0 else '')">
                                            <div class="row g-3 px-2">
                                                <t t-foreach="chunk" t-as="product">
                                                    <div class="col-md-3">
                                                        <t t-if="ecom_installed">
                                                            <a t-att-href="'/shop/product/' + slug(product)"
                                                               class="text-decoration-none text-reset">
                                                                <div class="card h-100 border-0 shadow-sm">
                                                                    <div class="d-flex align-items-center justify-content-center w-100"
                                                                         style="height: 220px; background: #fff;">
                                                                        <img t-if="product.image_1920"
                                                                             t-att-src="'/web/image/product.template/' + str(product.id) + '/image_1920/300x300'"
                                                                             class="img-fluid object-fit-contain"
                                                                             style="max-height: 200px;"/>
                                                                        <div t-else=""
                                                                             class="d-flex align-items-center justify-content-center w-100 h-100">
                                                                            <i class="fa fa-image fa-3x text-muted"/>
                                                                        </div>
                                                                    </div>
                                                                    <div class="card-body text-center">
                                                                        <h6 class="card-title mb-2"
                                                                            t-esc="product.name"/>
                                                                        <p class="text-primary fw-bold mb-0">₹
                                                                            <t t-esc="'{:,.2f}'.format(product.list_price)"/>
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        </t>
                                                        <t t-else="">
                                                            <a t-att-href="'/product/' + str(product.id)"
                                                               class="text-decoration-none text-reset">
                                                                <div class="card h-100 border-0 shadow-sm">
                                                                    <div class="d-flex align-items-center justify-content-center w-100"
                                                                         style="height: 220px; background: #fff;">
                                                                        <img t-if="product.image_1920"
                                                                             t-att-src="'data:image/png;base64,' + product.image_1920.decode('utf-8')"
                                                                             class="img-fluid object-fit-contain"
                                                                             style="max-height: 200px;"/>
                                                                        <div t-else=""
                                                                             class="d-flex align-items-center justify-content-center w-100 h-100">
                                                                            <i class="fa fa-image fa-3x text-muted"/>
                                                                        </div>
                                                                    </div>
                                                                    <div class="card-body text-center">
                                                                        <h6 class="card-title mb-2"
                                                                            t-esc="product.name"/>
                                                                        <p class="text-primary fw-bold mb-0">₹
                                                                            <t t-esc="'{:,.2f}'.format(product.list_price)"/>
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        </t>
                                                    </div>
                                                </t>
                                            </div>
                                        </div>
                                    </t>
                                </div>

                                <t t-if="len(featured_products_slider) > 4">
                                    <button class="carousel-control-prev" type="button"
                                            data-bs-target="#featuredCarouselDesktop" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button"
                                            data-bs-target="#featuredCarouselDesktop" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                </t>
                            </div>
                        </div>

                        <!-- Mobile Carousel -->
                        <div class="d-block d-md-none">
                            <div id="featuredCarouselMobile"
                                 class="carousel slide"
                                 data-bs-ride="carousel"
                                 data-bs-interval="2000"
                                 data-bs-pause="hover">
                                <div class="carousel-inner">
                                    <t t-foreach="featured_products_slider" t-as="product"
                                       t-foreach-index="product_index">
                                        <div t-att-class="'carousel-item' + (' active' if product_index == 0 else '')">
                                            <div class="row justify-content-center">
                                                <div class="col-10">
                                                    <t t-if="ecom_installed">
                                                        <a t-att-href="'/shop/product/' + slug(product)"
                                                           class="text-decoration-none text-reset">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="d-flex align-items-center justify-content-center w-100"
                                                                     style="height: 220px; background: #fff;">
                                                                    <img t-if="product.image_1920"
                                                                         t-att-src="'/web/image/product.template/' + str(product.id) + '/image_1920/300x300'"
                                                                         class="img-fluid object-fit-contain"
                                                                         style="max-height: 200px;"/>
                                                                    <div t-else=""
                                                                         class="d-flex align-items-center justify-content-center w-100 h-100">
                                                                        <i class="fa fa-image fa-3x text-muted"/>
                                                                    </div>
                                                                </div>
                                                                <div class="card-body text-center">
                                                                    <h6 class="card-title mb-2" t-esc="product.name"/>
                                                                    <p class="text-primary fw-bold mb-0">₹
                                                                        <t t-esc="'{:,.2f}'.format(product.list_price)"/>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </t>
                                                    <t t-else="">
                                                        <a t-att-href="'/product/' + str(product.id)"
                                                           class="text-decoration-none text-reset">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="d-flex align-items-center justify-content-center w-100"
                                                                     style="height: 220px; background: #fff;">

                                                                    <img t-if="product.image_1920"
                                                                         t-att-src="'data:image/png;base64,' + product.image_1920.decode('utf-8')"
                                                                         class="img-fluid object-fit-contain"
                                                                         style="max-height: 200px;"/>

                                                                    <div t-else=""
                                                                         class="d-flex align-items-center justify-content-center w-100 h-100">
                                                                        <i class="fa fa-image fa-3x text-muted"/>
                                                                    </div>
                                                                </div>
                                                                <div class="card-body text-center">
                                                                    <h6 class="card-title mb-2" t-esc="product.name"/>
                                                                    <p class="text-primary fw-bold mb-0">₹
                                                                        <t t-esc="'{:,.2f}'.format(product.list_price)"/>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </t>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>

                                <t t-if="len(featured_products_slider) > 1">
                                    <button class="carousel-control-prev" type="button"
                                            data-bs-target="#featuredCarouselMobile" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button"
                                            data-bs-target="#featuredCarouselMobile" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                </t>
                            </div>
                        </div>

                    </div>
                </div>
            </t>
        </xpath>
    </template>

    <!--    set page name  -->
    <template id="portal_breadcrumbs_page_name" inherit_id="portal.portal_breadcrumbs">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'Ticket'" class="breadcrumb-item">
                <a href="/my/view">All Tickets</a>
            </li>
            <li t-if="page_name == 'All Tickets'" class="breadcrumb-item">
                <a href="/my/view">All Tickets</a>
            </li>
            <li t-if="page_name == 'My Assets'" class="breadcrumb-item">
                <a href="/my/assets">All Assets</a>
            </li>
            <li t-if="page_name == 'Ticket' and ticket" class="breadcrumb-item active" aria-current="page">
                <t t-esc="ticket.name"/>
            </li>
            <li t-if="page_name == 'Open Tickets'" class="breadcrumb-item active">
                <a href="/my/open/ticket">Open Tickets</a>
            </li>
            <li t-if="page_name == 'Assets'" class="breadcrumb-item">
                <a href="/my/assets">All Assets</a>
            </li>
            <li t-if="page_name == 'Assets' and mapping" class="breadcrumb-item active" aria-current="page">
                <t t-esc="mapping.product_id.name"/>
            </li>
            <li t-if="page_name == 'Active Assets'" class="breadcrumb-item">
                <a href="/my/active/assets">Active Assets</a>
            </li>
            <li t-if="page_name == 'Create Ticket'" class="breadcrumb-item">
                <a href="/my/view">All Tickets</a>
            </li>
            <li t-if="page_name == 'Reschedule Ticket'" class="breadcrumb-item">
                <a t-att-href="'/my/ticket/%s' % ticket.id">Ticket</a>
            </li>
            <li t-if="page_name == 'Reschedule Ticket' and ticket" class="breadcrumb-item active" aria-current="page">
                <t t-esc="ticket.name"/>
            </li>
            <li t-if="page_name == 'Contract'" class="breadcrumb-item">
                <a href="/my/contract/list">All Contracts</a>
            </li>
            <li t-if="page_name == 'Contract' and contract" class="breadcrumb-item active" aria-current="page">
                <t t-esc="contract.name"/>
            </li>
            <li t-if="page_name == 'My Contracts'" class="breadcrumb-item active">
                <a href="/my/contract/list">All Contracts</a>
            </li>
            <li t-if="page_name == 'Quotation' and order.amc_contract_id" class="breadcrumb-item">
                <a t-att-href="'/my/contract/form/%s' % order.amc_contract_id.id">
                    <t t-esc="order.amc_contract_id.name"/>
                </a>
            </li>
            <li t-if="page_name == 'Quotation'" class="breadcrumb-item active" aria-current="page">
                <t t-esc="order.name"/>
            </li>
            <li t-if="page_name == 'All Products'" class="breadcrumb-item">
                <a href="/products">All Products</a>
            </li>
            <li t-if="page_name == 'All Products' and product_name" class="breadcrumb-item active" aria-current="page">
                <t t-esc="product_name"/>
            </li>
            <li t-if="page_name == 'All Product'" class="breadcrumb-item">
                <t>All Products</t>
            </li>
            <t t-if="page_name == 'All Product'">
                <div class="d-flex justify-content-end js-product-search-wrapper" style="max-width: 200px; margin-left:auto;">
                    <div class="position-relative w-100">
                        <input name="q" type="text"
                            class="form-control ps-4 pe-5 bg-light border-0 rounded js-product-search"
                            placeholder="Search..." autocomplete="off" />
                        <i class="fa fa-search text-muted"
                            style="position: absolute; top: 30%; right: 10px;" />
                        <ul class="dropdown-menu w-100 mt-1 shadow js-search-results" style="display: none; z-index:999;"/>
                    </div>
                </div>
            </t>
            <t t-if="page_name == 'My Assets'">
                <t t-if="(groupby == 'category' and grouped_products) or (not groupby and products)">
                    <div class="d-flex justify-content-end" style="max-width: 300px; margin-left:auto;">
                        <a href="/my/ticket/create"
                           class="btn btn-primary d-flex align-items-center justify-content-center"
                           style="padding: 4px 10px; font-size: 12px; height: 30px; min-width: 90px;">
                            Create Ticket
                        </a>
                    </div>
                </t>
            </t>
            <t t-if="page_name == 'All Tickets' and has_active_assets">
                <div class="d-flex justify-content-end" style="max-width: 300px; margin-left:auto;">
                    <a href="/my/ticket/create"
                       class="btn btn-primary d-flex align-items-center justify-content-center"
                       style="padding: 4px 10px; font-size: 12px; height: 30px; min-width: 90px;">
                        Create Ticket
                    </a>
                </div>
            </t>
            <li t-if="page_name == 'notifications'" class="breadcrumb-item">
                <t>Notifications</t>
            </li>
            <t t-if="page_name == 'notifications'">
                <div class="d-flex justify-content-end" style="max-width: 300px; margin-left:auto;">
                    <button id="enableNotificationBtn" class="btn btn-primary btn-sm mb-3" style="width: auto; padding: 4px 10px;">
                        Enable Notifications
                    </button>
                </div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        const btn = document.getElementById("enableNotificationBtn");
                        if (!btn) return;

                        function updateButtonState() {
                            // Always show button if permission is not granted
                            if (Notification.permission !== "granted") {
                                btn.style.display = "block";
                                if (Notification.permission === "denied") {
                                    btn.textContent = "Notifications blocked";
                                } else {
                                    btn.textContent = "Enable Notifications";
                                }
                            } else {
                                btn.style.display = "none";
                            }
                        }
                        btn.addEventListener("click", function () {
                            if (!("Notification" in window)) {
                                alert("This browser does not support notifications.");
                                return;
                            }

                            if (Notification.permission === "denied") {
                                alert(
                                    "Notifications are blocked. Please enable them from your browser's site settings."
                                );
                                // Optionally, open instructions page
                                return;
                            }

                            // If permission is default or granted, request again
                            Notification.requestPermission().then(function (permission) {
                                if (permission === "granted") {
                                    alert("Notifications enabled!");
                                    btn.style.display = "none";
                                    // Trigger your Odoo push subscription logic here
                                } else if (permission === "denied") {
                                    alert(
                                        "You have blocked notifications. Please enable them in browser settings."
                                    );
                                }
                            });
                        });

                        updateButtonState();
                    });
                </script>
            </t>
        </xpath>
    </template>

    <template id="customer_product_detail_form_view" name="Customer Product Detail">
        <t t-call="portal.portal_layout">
            <div class="container">
                <t t-if="mapping">
                    <div class="row">
                        <!-- Sidebar -->
                        <div class="col-lg-3 col-md-4 pe-4">
                            <div class="mb-4">
                                <div id="mapping-nav" class="d-flex align-items-center flex-grow-1 p-0"
                                     role="complementary">
                                    <div class="row g-2 w-100">
                                        <!-- Task -->
                                        <div class="col-6">
                                            <a href="#card_header" class="text-decoration-none">
                                                <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                     style="height: 40px;">
                                                    <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                        <span class="fw-semibold text-dark text-center"
                                                              style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                            Task
                                                        </span>
                                                    </h6>

                                                </div>
                                            </a>
                                        </div>

                                        <!-- History -->
                                        <div class="col-6">
                                            <a href="#mapping_chat" class="text-decoration-none">
                                                <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                     style="height: 40px;">
                                                    <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                        <span class="fw-semibold text-dark text-center"
                                                              style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                            History
                                                        </span>
                                                    </h6>
                                                </div>
                                            </a>
                                        </div>

                                        <!-- Create Ticket (below) -->
                                        <div class="col-12">
                                            <a t-attf-href="/my/ticket/create?product_mapping_id={{ mapping.id }}"
                                               class="text-decoration-none">
                                                <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                     style="height: 40px;">
                                                    <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                        <span class="fw-semibold text-dark text-center"
                                                              style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                            Create Ticket
                                                        </span>
                                                    </h6>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <br/>

                                <!-- Customer Details -->
                                <div class="d-flex flex-column gap-4 mt-3">
                                    <div class="col-12 d-flex flex-column">
                                        <div class="border rounded-3 p-3 bg-light mb-2">
                                            <h5>
                                                <small class="text-muted">Customer</small>
                                            </h5>
                                            <div class="o_portal_contact_details d-flex flex-column gap-2">
                                                <div class="d-flex justify-content-start align-items-center gap-2">
                                                    <img class="o_avatar o_portal_contact_img rounded"
                                                         t-att-src="image_data_uri(mapping.customer_id.avatar_512)"/>
                                                    <h6 class="mb-0" t-out="mapping.customer_id.name"/>
                                                </div>
                                                <div t-field="mapping.customer_id"
                                                     t-options='{"widget": "contact", "fields": ["email", "phone"]}'/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Main Content -->
                        <div class="col-lg-9 col-md-8 ps-4">
                            <t t-if="coverage_note">
                                <div class="alert alert-warning mb-3">
                                    <strong>Notice:</strong>
                                    <t t-esc="coverage_note"/>
                                </div>
                            </t>
                            <!-- Header -->
                            <div id="card_header" data-anchor="true">
                                <div class="row justify-content-between align-items-end mb-3">

                                    <div class="col-12 col-md-9">
                                        <div class="d-flex align-items-center gap-3">
                                            <img t-if="mapping.product_id.image_128"
                                                 t-att-src="'data:image/png;base64,' + mapping.product_id.image_128.decode('utf-8')"
                                                 class="rounded" style="width: 50px; height: 50px; object-fit: cover;"/>
                                            <h5 class="text-wrap text-break my-0" t-esc="mapping.product_id.name"/>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div>
                                            <small class="text-end">Status:</small>
                                                <t t-set="status_label"
                                                   t-value="dict(mapping.fields_get(['status'])['status']['selection']).get(mapping.status)"/>
                                                <span t-esc="status_label" class="badge rounded-pill text-bg-info" title="Current status of this asset"/>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- Details Section -->
                            <div id="card_body">
                                <div class="row mb-4 container">
                                    <div class="col-12 col-md-6 flex-grow-1">
                                        <div class="mb-2">
                                            <strong>Product Category:</strong>
                                            <span t-esc="mapping.product_id.categ_id.name"/>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Serial Number:</strong>
                                            <span t-esc="mapping.serial_number_ids.name or 'No Serial Number'"/>
                                        </div>
                                        <div class="mb-2">
                                        <strong>Coverage Period:</strong>
                                        <t t-esc="format_date(mapping.start_date)"/> to <t t-esc="format_date(mapping.end_date)"/>
                                    </div>

                                    </div>
                                    <div class="col-12 col-md-6 d-empty-none"></div>
                                </div>
                                <div class="row" t-if="mapping.description or mapping.attachment_ids">
                                    <div t-if="not is_html_empty(mapping.description)"
                                         t-attf-class="col-12 mb-4 mb-md-0 {{'col-lg-6' if mapping.attachment_ids else 'col-lg-12'}}">
                                        <hr class="mb-1"/>
                                        <div class="d-flex my-2">
                                            <h5>Description</h5>
                                        </div>
                                        <div class="py-1 px-2 bg-100 small table-responsive"
                                             t-field="mapping.description"/>
                                    </div>
                                    <div t-if="mapping.attachment_ids"
                                         t-attf-class="col-12 o_project_portal_attachments {{'col-lg-6' if mapping.description else 'col-lg-12'}}">
                                        <hr class="mb-1 d-none d-lg-block"/>
                                        <strong class="d-block mb-2">Attachments</strong>
                                        <div class="row">
                                            <div t-attf-class="col {{'col-lg-6' if not mapping.description else 'col-lg-12'}}">
                                                <ul class="list-group">
                                                    <t t-foreach="ticket.attachment_ids" t-as="attachment">
                                                        <t t-if="attachment.datas">
                                                            <a class="list-group-item list-group-item-action d-flex align-items-center oe_attachments py-1 px-2"
                                                               t-att-href="'data:application/octet-stream;base64,' + attachment.datas"
                                                               t-att-download="attachment.name">
                                                                <div class="oe_attachment_embedded o_image o_image_small me-2 me-lg-3"
                                                                     t-att-title="attachment.name"
                                                                     t-att-data-mimetype="attachment.mimetype"
                                                                     t-attf-style="background-image: url('data:image/*;base64,#{attachment.datas}'); background-size: cover; width: 50px; height: 40px; border-radius: 4px;">
                                                                </div>
                                                                <div class="oe_attachment_name text-truncate">
                                                                    <t t-esc="attachment.name"/>
                                                                </div>
                                                            </a>
                                                        </t>
                                                    </t>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr/>
                            </div>
                            <div id="mapping_chat" data-anchor="true" class="mt-4">
                                <h4>Communication History</h4>
                                <t t-set="object" t-value="mapping"/>
                                <t t-set="message_ids"
                                   t-value="mapping.message_ids.sorted(key=lambda m: m.date, reverse=False)"/>
                                <t t-set="token" t-value="mapping.access_token"/>
                                <t t-call="portal.message_thread"/>
                            </div>
                        </div>
                    </div>
                </t>
                <t t-else="">
                    <div class="alert alert-warning mt-4">
                        This product was not found or is not assigned to you.
                    </div>
                </t>
            </div>
        </t>
    </template>

    <template id="contract_form_view" name="Contract Form View">
        <t t-call="portal.portal_layout">
            <div class="container">
                <t t-if="contract">
                    <div class="row">
                        <!-- Sidebar -->
                        <div class="col-lg-3 col-md-4 pe-4">
                            <div class="mb-4">
                                <div class="row g-2 mb-4">
                                    <!-- Contract Card -->
                                    <div class="col-6">
                                        <a href="#contract_tasks" class="text-decoration-none">
                                            <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                 style="height: 45px;">
                                                <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                    <span class="fw-semibold text-dark text-center"
                                                          style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                        Contract
                                                    </span>
                                                </h6>
                                            </div>
                                        </a>
                                    </div>

                                    <!-- History Card -->
                                    <div class="col-6">
                                        <a href="#contract_history" class="text-decoration-none">
                                            <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                 style="height: 45px;">
                                                <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                    <span class="fw-semibold text-dark text-center"
                                                          style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                        History
                                                    </span>
                                                </h6>
                                            </div>
                                        </a>
                                    </div>

                                    <!-- Visit Card (offset if only 3 cards) -->
                                    <t t-if="contract.stage_id == 'active' and not sale_orders">
                                        <div class="col-12">
                                            <a href="#" class="text-decoration-none" data-bs-toggle="modal"
                                               data-bs-target="#visitModal">
                                                <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                     style="height: 45px;">
                                                    <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                        <span class="fw-semibold text-dark text-center"
                                                              style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                            Visit
                                                        </span>
                                                    </h6>
                                                </div>
                                            </a>
                                        </div>
                                    </t>
                                    <t t-if="contract.stage_id == 'active' and sale_orders">
                                        <div class="col-6">
                                            <a href="#" class="text-decoration-none" data-bs-toggle="modal"
                                               data-bs-target="#visitModal">
                                                <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                     style="height: 45px;">
                                                    <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                        <span class="fw-semibold text-dark text-center"
                                                              style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                            Visit
                                                        </span>
                                                    </h6>
                                                </div>
                                            </a>
                                        </div>
                                    </t>

                                    <!-- Assets Covered Card -->
                                    <t t-if="sale_orders">
                                        <t t-if="contract.stage_id != 'active'">
                                            <!-- Centered when Visit is not shown -->
                                            <div class="col-12">
                                                <a t-att-href="'/my/contract/%s/assets' % contract.id"
                                                   class="text-decoration-none">
                                                    <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                         style="height: 45px;">
                                                        <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                            <span class="fw-semibold text-dark text-center"
                                                                  style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                                Assets Covered
                                                            </span>
                                                        </h6>
                                                    </div>
                                                </a>
                                            </div>
                                        </t>
                                        <t t-else="">
                                            <!-- Normal layout when Visit is also shown -->
                                            <div class="col-6">
                                                <a t-att-href="'/my/contract/%s/assets' % contract.id"
                                                   class="text-decoration-none">
                                                    <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                         style="height: 45px;">
                                                        <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                            <span class="fw-semibold text-dark text-center"
                                                                  style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                                Assets Covered
                                                            </span>
                                                        </h6>
                                                    </div>
                                                </a>
                                            </div>
                                        </t>
                                    </t>
                                </div>
                                <br/>

                                <!-- Assignee Info -->
                                <div class="col-12" t-if="contract.user_ids">
                                    <div class="border rounded-3 p-3 bg-light mb-3">
                                        <h5 class="flex-basis-100">
                                            <small class="text-muted">Assignees</small>
                                        </h5>
                                        <t t-foreach="contract.user_ids" t-as="user">
                                            <div t-attf-class="o_portal_contact_details d-flex flex-column gap-2 {{ 'mb-3' if len(contract.user_ids) > 1 else '' }}">
                                                <div class="d-flex justify-content-start align-items-center gap-2">
                                                    <img class="o_avatar o_portal_contact_img rounded"
                                                         t-att-src="image_data_uri(user.avatar_128)"/>
                                                    <h6 class="mb-0" t-field="user.name"></h6>
                                                </div>
                                                <div t-out="user"
                                                     t-options='{"widget": "contact", "fields": ["email", "phone"]}'/>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="col-lg-9 col-md-8 ps-4">
                            <t t-if="next_renewal">
                                <div class="alert alert-warning mb-3">
                                    <strong>Notice:</strong>
                                    <t t-esc="next_renewal"/>
                                </div>
                            </t>

                            <!-- Header -->
                            <div class="row justify-content-between align-items-end mb-3" id="contract_tasks"
                                 data-anchor="true">
                                <div class="col-12 col-md-9">
                                    <h5 class="text-wrap text-break my-0" t-esc="contract.name"/>
                                </div>
                                <div class="col-auto">
                                    <div>
                                        <small class="text-end">Contract Status:</small>
                                        <span class="badge rounded-pill text-bg-info">
                                            <t t-esc="dict(contract._fields['stage_id'].selection).get(contract.stage_id, 'N/A')"/>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Contract Details -->
                            <div class="row mb-4 container">
                                <div class="col-12 col-md-6 flex-grow-1">
                                    <div class="mb-2">
                                        <strong>Coverage Type:</strong>
                                        <span t-esc="contract.contract_type.name or 'N/A'"/>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Coverage Start Date:</strong>
                                        <t t-esc="format_date(contract.start_date)"/>
                                    </div>
                                    <div class="mb-2">
                                         <strong>Coverage End Date:</strong>
                                        <t t-esc="format_date(contract.end_date)"/>
                                    </div>
                                    <div class="mb-2">
                                         <strong>Contact Number:</strong>
                                         <t t-esc="contract.phone or 'N/A'"/>
                                    </div>
                                    <div class="mb-2">
                                         <strong>Service Location:</strong>
                                        <t t-esc="contract.service_address"/>
                                    </div>
                                    <t t-if="sale_orders">
                                        <div class="mb-2">
                                            <strong>Quotations:</strong>
                                        </div>

                                        <div class="container mt-4">
                                            <div class="accordion-body p-0">
                                                <table class="table table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Quotation</th>
                                                            <th>Date</th>
                                                            <th>Salesperson</th>
                                                            <th>Customer</th>
                                                            <th>Total</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="sale_orders" t-as="order">
                                                            <tr>
                                                                <td>
                                                                    <a t-att-href="'/my/quotation/orders/%d' % order.id">
                                                                        <t t-esc="order.name"/>
                                                                    </a>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="format_date(order.date_order.date())"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="order.user_id.name or 'N/A'"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="order.partner_id.name or 'N/A'"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="'%s %.2f' % (order.currency_id.symbol, order.amount_total)"/>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-primary text-white">
                                                                        <t t-esc="dict(order._fields['state'].selection).get(order.state, 'N/A')"/>
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </t>

                                    <!-- invoice list-->
                                    <t t-if="invoices">
                                        <div class="container mt-4">
                                            <h5>Invoices</h5>
                                            <div class="accordion-body p-0">
                                                <table class="table table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Invoice</th>
                                                            <th>Date</th>
                                                            <th>Due Date</th>
                                                            <th>Total</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="invoices" t-as="inv">
                                                            <tr>
                                                                <td>
                                                                    <a t-att-href="'/my/invoice/%d' % inv.id">
                                                                        <t t-esc="inv.name"/>
                                                                    </a>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="format_date(inv.invoice_date)"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="format_date(inv.invoice_date_due)"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="'%s %.2f' % (inv.currency_id.symbol, inv.amount_total)"/>
                                                                </td>
                                                                <td>
                                                                    <span t-att-class="'badge ' + ('bg-success' if inv.state == 'posted' else 'bg-secondary')">
                                                                        <t t-esc="dict(inv._fields['payment_state'].selection).get(inv.payment_state, 'N/A')"/>
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </t>
                                    <br/>
                                </div>
                                <div class="col-12 col-md-6 d-empty-none"></div>
                            </div>

                            <!-- Description & Attachments -->
                            <div class="row" t-if="contract.comment or contract.attachment_line_ids">
                                <div t-if="not is_html_empty(contract.comment)"
                                     t-attf-class="col-12 mb-4 mb-md-0 {{'col-lg-6' if contract.attachment_line_ids else 'col-lg-12'}}">
                                    <hr class="mb-1"/>
                                    <div class="d-flex my-2">
                                        <h5>Description</h5>
                                    </div>
                                    <div class="py-1 px-2 bg-100 small table-responsive" t-field="contract.comment"/>
                                </div>
                                <div t-if="contract.attachment_line_ids"
                                     t-attf-class="col-12 o_project_portal_attachments {{'col-lg-6' if contract.comment else 'col-lg-12'}}">
                                    <hr class="mb-1 d-none d-lg-block"/>
                                    <strong class="d-block mb-2">Attachments</strong>
                                    <div class="row">
                                        <div class="col">
                                            <ul class="list-group">
                                                <t t-foreach="contract.attachment_line_ids" t-as="attachment">
                                                    <t t-if="attachment.upload_file">
                                                        <a class="list-group-item list-group-item-action d-flex align-items-center oe_attachments py-1 px-2"
                                                           t-att-download="attachment.upload_file_filename"
                                                           t-attf-href="data:application/octet-stream;base64,#{attachment.upload_file}">
                                                            <div class="oe_attachment_embedded o_image o_image_small me-2 me-lg-3"
                                                                 t-att-title="attachment.upload_file_filename"
                                                                 t-attf-style="background-image: url('data:image/*;base64,#{attachment.upload_file}'); background-size: cover; width: 50px; height: 40px; border-radius: 4px;">
                                                            </div>
                                                            <div class="oe_attachment_name text-truncate">
                                                                <t t-esc="attachment.upload_file_filename"/>
                                                            </div>
                                                        </a>
                                                    </t>
                                                </t>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Chatter -->
                            <div id="contract_history" data-anchor="true" class="mt-4">
                                <h4>Communication History</h4>
                                <t t-set="object" t-value="contract"/>
                                <t t-set="message_ids"
                                   t-value="contract.message_ids.sorted(key=lambda m: m.date, reverse=False)"/>
                                <t t-set="token" t-value="contract.access_token"/>
                                <t t-call="portal.message_thread"/>
                            </div>
                        </div>
                    </div>
                </t>
                <t t-else="">
                    <div class="alert alert-warning mt-4">
                        No active contract was found for your account.
                    </div>
                </t>
            </div>
            <!-- Schedule Visit -->
            <div class="modal fade" id="visitModal" tabindex="-1" aria-labelledby="visitModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="visitModalLabel">Scheduled Visits</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                        </div>
                        <div class="modal-body">
                            <t t-set="today" t-value="datetime.date.today()"/>
                            <t t-set="upcoming_visits"
                               t-value="[v for v in contract.visit_ids if v.visit_date and v.visit_date >= today]"/>
                            <t t-if="upcoming_visits">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Scheduled Date</th>
                                            <th>Assignee</th>
                                            <th>Contract</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="upcoming_visits" t-as="visit">
                                            <tr>
                                                <td>
                                                    <t t-esc="format_date(visit.visit_date)"/>
                                                </td>
                                                <td>
                                                    <t t-if="visit.technician_ids">
                                                        <span>
                                                            <t t-foreach="visit.technician_ids" t-as="tech"
                                                               t-index="index">
                                                                <t t-esc="tech.name"/>
                                                                <t t-if="visit.technician_ids and index != len(visit.technician_ids) - 1">
                                                                    ,
                                                                </t>
                                                            </t>
                                                        </span>
                                                    </t>
                                                    <t t-else="">'N/A'</t>
                                                </td>
                                                <td>
                                                    <t t-esc="visit.contract_id.name or 'N/A'"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </t>
                            <t t-else="">
                                <div class="alert alert-warning">
                                    No visit records found for this contract.
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="amc_quotation_template" name="AMC Quotation Full Page">
        <t t-call="sale.sale_order_portal_template">
            <t t-set="main_content">
                <t t-call="sale.sale_order_portal_content"/>
            </t>
        </t>
    </template>

    <template id="amc_invoice_template" name="Invoice/Bill" inherit_id="portal.portal_sidebar" primary="True">
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <t t-set="o_portal_fullwidth_alert"
               groups="sales_team.group_sale_salesman,account.group_account_invoice,account.group_account_readonly">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url"
                       t-value="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (invoice._name, invoice.id, invoice.env.ref('account.action_move_out_invoice_type').id)"/>
                </t>
            </t>

            <div class="row o_portal_invoice_sidebar">
                <!-- Sidebar -->
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="classes" t-value="'col-lg-3 col-xl-4 d-print-none me-lg-auto'"/>
                    <t t-set="title">
                        <h2>
                            <span t-if="invoice.amount_residual > 0" t-field="invoice.amount_residual"/>
                            <span t-else="1" t-field="invoice.amount_total"/>
                        </h2>
                        <div class="small"
                             t-if="invoice.payment_state not in ('paid', 'in_payment', 'reversed') and invoice.move_type == 'out_invoice'">
                            <i class="fa fa-clock-o"/>
                            <span class="o_portal_sidebar_timeago ml4" t-att-datetime="invoice.invoice_date_due"/>
                        </div>
                    </t>

                    <t t-set="entries">
                        <div class="d-flex flex-column gap-4">
                            <div class="flex-basis-100 flex-basis-sm-50 flex-basis-lg-100 order-1 order-lg-0">
                                <div class="o_download_pdf d-flex gap-1 flex-lg-column flex-xl-row">
                                    <div class="flex-grow-1">
                                        <a class="btn btn-secondary d-block o_download_btn"
                                           t-att-href="invoice.get_portal_url(report_type='pdf', download=True)"
                                           title="Download">
                                            <i class="fa fa-download"/>
                                            Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div t-if="invoice.invoice_user_id" class="flex-grow-1">
                                <h6>
                                    <small class="text-muted">
                                        <t t-if="invoice.move_type == 'out_invoice'">
                                            Salesperson
                                        </t>
                                        <t t-if="invoice.move_type == 'in_invoice'">
                                            Purchase Representative
                                        </t>
                                    </small>
                                </h6>
                                <div class="o_portal_contact_details d-flex flex-column gap-2">
                                    <div class="d-flex justify-content-start align-items-center gap-2">
                                        <img class="o_avatar o_portal_contact_img rounded"
                                             t-att-src="image_data_uri(invoice.invoice_user_id.avatar_128)"
                                             alt="Contact"/>
                                        <div>
                                            <h6 class="mb-0" t-out="invoice.invoice_user_id.name"/>
                                            <a href="#discussion" class="d-flex align-items-center gap-2 small fw-bold">
                                                Send message
                                            </a>
                                        </div>
                                    </div>
                                    <div t-field="invoice.invoice_user_id"
                                         t-options='{"widget": "contact", "fields": ["city", "phone"]}'/>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>

                <!-- Page Content -->
                <div id="invoice_content" class="o_portal_content col-12 col-lg-9 col-xl-8">
                    <t t-if="error or warning" t-call="account.portal_invoice_error"/>
                    <t t-if="success and (not error and not warning)" t-call="account.portal_invoice_success"/>

                    <div class="o_portal_html_view shadow p-3">
                        <div class="o_portal_html_loader text-center">
                            <i class="fa fa-circle-o-notch fa-spin fa-2x fa-fw text-black-50"></i>
                        </div>
                        <iframe id="invoice_html" class="mt8 mb8" width="100%" height="100%" frameborder="0"
                                scrolling="no" t-att-src="invoice.get_portal_url(report_type='html')"/>
                    </div>
                    <!-- chatter -->
                    <div id="invoice_communication" class="mt-4">
                        <h4>Communication history</h4>
                        <t t-call="portal.message_thread"/>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <template id="contract_list_view" name="Contract List">
        <t t-call="portal.portal_layout">
            <div class="container">
                <!-- Search Bar in Header -->
                <t t-call="portal.portal_searchbar">
                    <t t-set="title" t-value="'All Contracts'"/>
                    <t t-set="searchbar_combined" t-value="searchbar_combined"/>
                    <t t-set="searchbar_inputs" t-value="searchbar_inputs"/>
                    <t t-set="search_in" t-value="search_in"/>
                    <t t-set="filterby" t-value="filterby"/>
                    <t t-set="groupby" t-value="groupby"/>
                    <t t-set="search" t-value="search"/>
                    <t t-set="default_url" t-value="default_url"/>
                </t>

                <!-- Grouped View -->
                <t t-if="grouped_contracts">
                    <div class="accordion" id="contractAccordion">
                        <t t-foreach="grouped_contracts.items()" t-as="group">
                            <t t-set="type_name" t-value="group[0]"/>
                            <t t-set="type_contracts" t-value="group[1]"/>
                            <t t-set="type_id" t-value="'type-' + type_name.replace(' ', '_').replace('/', '_')"/>

                            <div class="accordion-item">
                                <h2 class="accordion-header" t-attf-id="heading-#{type_id}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            t-attf-data-bs-target="#collapse-#{type_id}" aria-expanded="false"
                                            t-attf-aria-controls="collapse-#{type_id}">
                                        <t t-esc="type_name or 'No Type'"/>
                                    </button>
                                </h2>
                                <div t-attf-id="collapse-#{type_id}" class="accordion-collapse collapse"
                                     t-attf-aria-labelledby="heading-#{type_id}" data-bs-parent="#contractAccordion">
                                    <div class="accordion-body p-4">
                                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                            <table class="table table-hover mb-0 o_portal_my_doc_table">
                                                <thead>
                                                    <tr>
                                                        <th class="sortable">Contract Name
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Coverage Type
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Coverage Start Date
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Coverage End Date
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Stage
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Contact Number
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Service Address
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="type_contracts" t-as="contract">
                                                        <tr>
                                                            <td class="wrap-text">
                                                                <a t-att-href="'/my/contract/form/%s' % contract.id">
                                                                    <t t-esc="contract.name or 'N/A'"/>
                                                                </a>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <t t-esc="contract.contract_type.name or 'N/A'"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="contract.start_date and format_date(contract.start_date) or 'N/A'"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="contract.end_date and format_date(contract.end_date) or 'N/A'"/>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-primary"
                                                                      t-esc="stage_selection.get(contract.stage_id, 'N/A')"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="contract.phone or 'N/A'"/>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <t t-esc="contract.service_address or 'N/A'"/>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </t>

                <!-- Flat Table View -->
                <t t-elif="not groupby">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover o_list_view o_portal_my_doc_table">
                            <thead>
                                <tr>
                                    <th class="sortable">Contract Name<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Coverage Type<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Coverage Start Date<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Coverage End Date<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Stage<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Contact Number<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Service Address<i class="fa fa-sort ms-1"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="contracts" t-as="contract">
                                    <tr>
                                        <td class="wrap-text">
                                            <a t-att-href="'/my/contract/form/%s' % contract.id">
                                                <t t-esc="contract.name or 'N/A'"/>
                                            </a>
                                        </td>
                                        <td>
                                            <t t-esc="contract.contract_type.name or 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="contract.start_date and format_date(contract.start_date) or 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="contract.end_date and format_date(contract.end_date) or 'N/A'"/>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary"
                                                  t-esc="stage_selection.get(contract.stage_id, 'N/A')"/>
                                        </td>
                                        <td>
                                            <t t-esc="contract.phone or 'N/A'"/>
                                        </td>
                                        <td class="wrap-text">
                                            <t t-esc="contract.service_address or 'N/A'"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- No Results -->
                <t t-else="">
                    <div class="alert alert-warning">You don't have any contracts.</div>
                </t>
            </div>
        </t>
    </template>

    <template id="open_ticket_list_view" name="Ticket List">
        <t t-call="portal.portal_layout">
            <div class="container">
                <!-- Search Bar in Header -->
                <t t-call="portal.portal_searchbar">
                    <t t-set="title" t-value="'Open Tickets'"/>
                    <t t-set="searchbar_combined" t-value="searchbar_combined"/>
                    <t t-set="searchbar_inputs" t-value="searchbar_inputs"/>
                    <t t-set="search_in" t-value="search_in"/>
                    <t t-set="filterby" t-value="filterby"/>
                    <t t-set="groupby" t-value="groupby"/>
                    <t t-set="search" t-value="search"/>
                    <t t-set="default_url" t-value="default_url"/>
                </t>

                <t t-if="grouped_calls">
                    <div class="accordion" id="stageAccordion">
                        <t t-foreach="grouped_calls.items()" t-as="group">
                            <t t-set="group_name" t-value="group[0]"/>
                            <t t-set="group_calls" t-value="group[1]"/>
                            <t t-set="group_id" t-value="'group-' + group_name.replace(' ', '_').replace('/', '_')"/>

                            <div class="accordion-item">
                                <h2 class="accordion-header" t-attf-id="heading-#{group_id}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            t-attf-data-bs-target="#collapse-#{group_id}" aria-expanded="false"
                                            t-attf-aria-controls="collapse-#{group_id}">
                                        <t t-esc="group_name or 'Undefined Group'"/>
                                    </button>
                                </h2>

                                <div t-attf-id="collapse-#{group_id}" class="accordion-collapse collapse"
                                     t-attf-aria-labelledby="heading-#{group_id}" data-bs-parent="#stageAccordion">
                                    <div class="accordion-body p-4">
                                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                            <table class="table table-hover mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="sortable">Ticket Number
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Call Name
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Product
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Creation Date
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Expected Date
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Assignee
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Stage
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="group_calls" t-as="call">
                                                        <tr>
                                                            <td>
                                                                <t t-esc="call.sequence_fsm or 'N/A'"/>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <a t-attf-href="/my/ticket/#{call.id}"
                                                                   t-esc="call.name"/>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <t t-esc="(call.customer_product_id.product_id.name if call.customer_product_id else '') or 'N/A'"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="format_date(call.create_date)"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="format_date(call.planned_date_begin)"/>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <t t-esc="call.user_ids and call.user_ids[0].name or 'N/A'"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="call.stage_id.name or 'N/A'"/>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </t>
                <t t-elif="not groupby">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover o_list_view o_portal_my_doc_table">
                            <thead>
                                <tr>
<!--                                    <th></th>-->
                                    <th class="sortable">Ticket Number<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Call Name<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Product<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Creation Date</th>
                                    <th class="sortable">Expected Date<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Assignee<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Stage<i class="fa fa-sort ms-1"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="current_project" t-value="None"/>
                                <t t-foreach="calls" t-as="call">
                                    <tr>
                                        <td>
                                            <t t-esc="call.sequence_fsm or 'N/A'"/>
                                        </td>
                                        <td class="wrap-text">
                                            <a t-attf-href="/my/ticket/#{call.id}" t-esc="call.name"/>
                                        </td>
                                        <td class="wrap-text">
                                            <t t-esc="(call.customer_product_id.product_id.name if call.customer_product_id else '') or 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="format_date(call.create_date) if call.create_date else 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="format_date(call.planned_date_begin) if call.planned_date_begin else 'N/A'"/>
                                        </td>
                                        <td class="wrap-text">
                                            <t t-esc="call.user_ids.name or 'N/A'"/>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary" t-esc="call.stage_id.name or 'N/A'"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- No Results -->
                <t t-else="">
                    <div class="alert alert-warning">No FSM calls assigned to you.</div>
                </t>
            </div>
        </t>
    </template>

    <!--    ticket list view -->
    <template id="ticket_list_view" name="Ticket List">
        <t t-call="portal.portal_layout">
            <div class="container">
                <t t-call="portal.portal_searchbar">
                    <t t-set="title" t-value="'All Tickets'"/>
                    <t t-set="searchbar_combined" t-value="searchbar_combined"/>
                    <t t-set="searchbar_inputs" t-value="searchbar_inputs"/>
                    <t t-set="search_in" t-value="search_in"/>
                    <t t-set="filterby" t-value="filterby"/>
                    <t t-set="groupby" t-value="groupby"/>
                    <t t-set="search" t-value="search"/>
                    <t t-set="default_url" t-value="default_url"/>
                </t>

                <t t-if="grouped_calls">
                    <div class="accordion" id="stageAccordion">
                        <t t-foreach="grouped_calls.items()" t-as="group">
                            <t t-set="group_name" t-value="group[0]"/>
                            <t t-set="group_calls" t-value="group[1]"/>
                            <t t-set="group_id" t-value="'group-' + group_name.replace(' ', '_').replace('/', '_')"/>

                            <div class="accordion-item">
                                <h2 class="accordion-header" t-attf-id="heading-#{group_id}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            t-attf-data-bs-target="#collapse-#{group_id}" aria-expanded="false"
                                            t-attf-aria-controls="collapse-#{group_id}">
                                        <t t-esc="group_name or 'Undefined Group'"/>
                                    </button>
                                </h2>

                                <div t-attf-id="collapse-#{group_id}" class="accordion-collapse collapse"
                                     t-attf-aria-labelledby="heading-#{group_id}" data-bs-parent="#stageAccordion">
                                    <div class="accordion-body p-4">
                                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                            <table class="table table-hover mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="sortable">Ticket Number
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Call Name
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Product
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Creation Date
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Expected Date
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Assignee
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                        <th class="sortable">Stage
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="group_calls" t-as="call">
                                                        <tr>
                                                            <td>
                                                                <t t-esc="call.sequence_fsm or 'N/A'"/>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <a t-attf-href="/my/ticket/#{call.id}"
                                                                   t-esc="call.name"/>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <t t-esc="(call.customer_product_id.product_id.name if call.customer_product_id else '') or 'N/A'"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="format_date(call.create_date)"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="format_date(call.planned_date_begin)"/>
                                                            </td>
                                                            <td class="wrap-text">
                                                                <t t-esc="call.user_ids and call.user_ids[0].name or 'N/A'"/>
                                                            </td>
                                                            <td>
                                                                <t t-esc="call.stage_id.name or 'N/A'"/>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </t>
                <t t-elif="not groupby">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table o_portal_my_doc_table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="sortable">Ticket Number <i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Call Name <i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Product <i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Creation Date <i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Expected Date <i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Assignee <i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Stage <i class="fa fa-sort ms-1"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="current_project" t-value="None"/>
                                <t t-foreach="calls" t-as="call">
                                    <tr>
                                        <td>
                                            <t t-esc="call.sequence_fsm or 'N/A'"/>
                                        </td>
                                        <td class="wrap-text">
                                            <a t-attf-href="/my/ticket/#{call.id}" t-esc="call.name"/>
                                        </td>
                                        <td class="wrap-text">
                                            <t t-esc="(call.customer_product_id.product_id.name if call.customer_product_id else '') or 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="format_date(call.create_date) if call.create_date else 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="format_date(call.planned_date_begin) if call.planned_date_begin else 'N/A'"/>
                                        </td>
                                        <td class="wrap-text">
                                            <t t-esc="call.user_ids.name or 'N/A'"/>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary" t-esc="call.stage_id.name or 'N/A'"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- No Results -->
                <t t-else="">
                    <div class="alert alert-warning">No FSM calls assigned to you.</div>
                </t>
            </div>
        </t>
    </template>

    <!--    Active Assets List view  -->
    <template id="active_assets_list_view" name="Active Assets">
        <t t-call="portal.portal_layout">
            <div class="container">

                <!-- Search Bar -->
                <t t-call="portal.portal_searchbar">
                    <t t-set="title" t-value="'Active Assets'"/>
                    <t t-set="searchbar_combined" t-value="searchbar_combined"/>
                    <t t-set="searchbar_inputs" t-value="searchbar_inputs"/>
                    <t t-set="search_in" t-value="search_in"/>
                    <t t-set="filterby" t-value="filterby"/>
                    <t t-set="groupby" t-value="groupby"/>
                    <t t-set="search" t-value="search"/>
                    <t t-set="default_url" t-value="default_url"/>
                </t>

                <!-- Grouped View -->
                <t t-if="grouped_products">
                    <div class="accordion" id="productAccordion">
                        <t t-foreach="grouped_products.items()" t-as="group">
                            <t t-set="category_name" t-value="group[0]"/>
                            <t t-set="category_products" t-value="group[1]"/>
                            <t t-set="cat_id" t-value="'cat-' + category_name.replace(' ', '_').replace('/', '_')"/>

                            <div class="accordion-item">
                                <h2 class="accordion-header" t-attf-id="heading-#{cat_id}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            t-attf-data-bs-target="#collapse-#{cat_id}" aria-expanded="false"
                                            t-attf-aria-controls="collapse-#{cat_id}">
                                        <t t-esc="category_name or 'Uncategorized'"/>
                                    </button>
                                </h2>
                                <div t-attf-id="collapse-#{cat_id}" class="accordion-collapse collapse"
                                     t-attf-aria-labelledby="heading-#{cat_id}" data-bs-parent="#productAccordion">
                                    <div class="accordion-body p-4">
                                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                                <table class="table table-hover mb-0 o_portal_my_doc_table">
                                                    <thead>
                                                        <tr>
                                                            <!--<th>Unique Number</th>-->
                                                            <th class="sortable">Serial Number
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">Product Name
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">Unit Status
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">Start Date
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">End Date
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="category_products" t-as="item">
                                                            <t t-set="product" t-value="item['product']"/>
                                                            <t t-set="mapping" t-value="item['mapping']"/>
                                                            <tr>
                                                                <td>
                                                                    <t t-esc="mapping.serial_number_ids.name or 'N/A'"/>
                                                                </td>
                                                                <td>
                                                                    <a t-attf-href="/my/asset/#{mapping.id}">
                                                                        <t t-esc="product.name or 'N/A'"/>
                                                                    </a>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="mapping.status or 'N/A'"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="item['start_date_fmt']"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="item['end_date_fmt']"/>
                                                                </td>

                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </t>

                <!-- Flat Table View -->
                <t t-elif="not groupby">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover o_list_view o_portal_my_doc_table">
                            <thead>
                                <tr>
                                    <th class="sortable">Serial Number<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Product Name<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Unit Status<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Start Date<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">End Date<i class="fa fa-sort ms-1"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="product_data" t-as="item">
                                    <t t-set="product" t-value="item['product']"/>
                                    <t t-set="mapping" t-value="item['mapping']"/>
                                    <tr>
                                        <td>
                                            <t t-esc="mapping.serial_number_ids.name or 'N/A'"/>
                                        </td>
                                        <td class="wrap-text">
                                            <a t-attf-href="/my/asset/#{mapping.id}">
                                                <t t-esc="product.name or 'N/A'"/>
                                            </a>
                                        </td>
                                        <td>
                                            <t t-esc="mapping.status or 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="item['start_date_fmt']"/>
                                        </td>
                                        <td>
                                            <t t-esc="item['end_date_fmt']"/>
                                        </td>

                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- No Results -->
                <t t-else="">
                    <div class="alert alert-warning">You don't have any active assets.</div>
                </t>

            </div>
        </t>
    </template>

    <template id="product_list_view" name="Product List">
        <t t-call="portal.portal_layout">
            <div class="container">
                <t t-call="portal.portal_searchbar">
                    <t t-set="title" t-value="'All Assets'"/>
                    <t t-set="searchbar_combined" t-value="searchbar_combined"/>
                    <t t-set="searchbar_inputs" t-value="searchbar_inputs"/>
                    <t t-set="search_in" t-value="search_in"/>
                    <t t-set="filterby" t-value="filterby"/>
                    <t t-set="groupby" t-value="groupby"/>
                    <t t-set="search" t-value="search"/>
                    <t t-set="default_url" t-value="default_url"/>
                </t>

                <!-- Grouped View -->
                <t t-if="grouped_products">
                    <div class="accordion" id="productAccordion">
                        <t t-foreach="grouped_products.items()" t-as="group">
                            <t t-set="category_name" t-value="group[0]"/>
                            <t t-set="category_products" t-value="group[1]"/>
                            <t t-set="cat_id" t-value="'cat-' + category_name.replace(' ', '_').replace('/', '_')"/>

                            <div class="accordion-item">
                                <h2 class="accordion-header" t-attf-id="heading-#{cat_id}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            t-attf-data-bs-target="#collapse-#{cat_id}" aria-expanded="false"
                                            t-attf-aria-controls="collapse-#{cat_id}">
                                        <t t-esc="category_name or 'Uncategorized'"/>
                                    </button>
                                </h2>
                                <div t-attf-id="collapse-#{cat_id}" class="accordion-collapse collapse"
                                     t-attf-aria-labelledby="heading-#{cat_id}" data-bs-parent="#productAccordion">
                                    <div class="accordion-body p-4">
                                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                                <table class="table table-hover mb-0 o_portal_my_doc_table">
                                                    <thead>
                                                        <tr>
                                                            <!--<th>Unique Number</th>-->
                                                            <th class="sortable">Serial Number
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">Product Name
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">Unit Status
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">Start Date
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                            <th class="sortable">End Date
                                                                <i class="fa fa-sort ms-1"></i>
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="category_products" t-as="product">
                                                            <tr>
                                                                <td>
                                                                    <t t-if="product['serial_number_ids']">
                                                                        <t t-foreach="product['serial_number_ids']"
                                                                           t-as="sn" t-separator=", ">
                                                                            <t t-esc="sn['name']"/>
                                                                        </t>
                                                                    </t>
                                                                    <t t-if="not product['serial_number_ids']">
                                                                        N/A
                                                                    </t>
                                                                </td>

                                                                <td class="wrap-text">
                                                                    <a t-attf-href="/my/asset/#{product['mapping_id']}"
                                                                       t-esc="product['name']"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="product['status'] or 'N/A'"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="format_date(product['start_date'])"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="format_date(product['end_date'])"/>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </t>

                <!-- Flat View -->
                <t t-elif="not groupby">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover o_list_view o_portal_my_doc_table">
                            <thead>
                                <tr>
                                    <th class="sortable">Serial Number<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Product Name<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Unit Status<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">Start Date<i class="fa fa-sort ms-1"></i></th>
                                    <th class="sortable">End Date<i class="fa fa-sort ms-1"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="products" t-as="product">
                                    <tr>
                                        <td>
                                            <t t-if="product['serial_number_ids']">
                                                <t t-foreach="product['serial_number_ids']" t-as="sn" t-separator=", ">
                                                    <t t-esc="sn['name']"/>
                                                </t>
                                            </t>
                                            <t t-if="not product['serial_number_ids']">
                                                N/A
                                            </t>
                                        </td>
                                        <td class="wrap-text">
                                            <a t-attf-href="/my/asset/#{product['mapping_id']}"
                                               t-esc="product['name']"/>
                                        </td>
                                        <td>
                                            <t t-esc="product['status'] or 'N/A'"/>
                                        </td>
                                        <td>
                                            <t t-esc="format_date(product['start_date'])"/>
                                        </td>
                                        <td>
                                            <t t-esc="format_date(product['end_date'])"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- No Results -->
                <t t-else="">
                    <div class="alert alert-warning">You don't have any products.</div>
                </t>

            </div>
        </t>
    </template>

    <!-- ticket form view -->
    <template id="ticket_form_view" name="Call View">
        <t t-call="portal.portal_layout">
            <div class="container">
                <t t-if="ticket">
                    <div class="row">
                        <!-- Sidebar -->
                        <div class="col-lg-3 col-md-4 pe-4">
                            <div class="mb-4">
                                <div id="ticket-nav" class="d-flex align-items-center flex-grow-1 p-0" t-ignore="true"
                                     role="complementary">
                                    <div class="row g-2 w-100">
                                        <!-- Task -->
                                        <div class="col-6">
                                            <a href="#card_header" class="text-decoration-none">
                                                <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                     style="height: 40px;">
                                                    <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                        <span class="fw-semibold text-dark text-center"
                                                              style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                            Call
                                                        </span>
                                                    </h6>
                                                </div>
                                            </a>
                                        </div>

                                        <!-- History -->
                                        <div class="col-6">
                                            <a href="#ticket_chat" class="text-decoration-none">
                                                <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                     style="height: 40px;">
                                                    <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                        <span class="fw-semibold text-dark text-center"
                                                              style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                            History
                                                        </span>
                                                    </h6>
                                                </div>
                                            </a>
                                        </div>

                                        <!-- Re-schedule -->
                                        <t t-set="show_reschedule"
                                           t-value="ticket.stage_id.name in ['New', 'Assigned']"/>
                                        <t t-set="show_cancel"
                                           t-value="ticket.stage_id.name in ['New', 'Assigned', 'Planned']"/>

                                        <t t-if="show_reschedule">
                                            <div class="col-6">
                                                <a t-att-href="'/my/ticket/reschedule/%d' % ticket.id"
                                                   class="text-decoration-none">
                                                    <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                         style="height: 40px;">
                                                        <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                            <span class="fw-semibold text-dark text-center"
                                                                  style="margin: 2px 0; padding: 2px 0; font-size: 15px;">Re-schedule
                                                            </span>
                                                        </h6>
                                                    </div>
                                                </a>
                                            </div>
                                        </t>
                                        <!-- Cancel -->
                                        <t t-if="show_cancel">
                                            <div t-attf-class="col-#{'6' if show_reschedule else '12'}">
                                                <a href="#" class="text-decoration-none" data-bs-toggle="modal"
                                                   data-bs-target="#cancelModal">
                                                    <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                         style="height: 40px;">
                                                        <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                            <span class="fw-semibold text-dark text-center"
                                                                  style="margin: 2px 0; padding: 2px 0; font-size: 15px;">Cancel
                                                            </span>
                                                        </h6>
                                                    </div>
                                                </a>
                                            </div>
                                        </t>

                                        <!-- Feedback -->
                                        <t t-if="ticket.stage_id.name in ['Resolved', 'Done', 'Cancelled']">
                                            <div class="col-12">
                                                <a href="#" class="text-decoration-none" data-bs-toggle="modal"
                                                   data-bs-target="#feedbackModal">
                                                    <div class="border rounded-3 p-3 bg-light d-flex align-items-center justify-content-center"
                                                         style="height: 40px;">
                                                        <h6 class="m-0 p-0 w-100 d-flex justify-content-center align-items-center">
                                                            <span class="fw-semibold text-dark text-center"
                                                                  style="margin-top: 2px; margin-bottom: 2px; padding-top: 2px; padding-bottom: 2px; font-size: 15px">
                                                                Feedback
                                                            </span>
                                                        </h6>
                                                    </div>
                                                </a>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                                <div id="ticket-links" t-if="ticket_link_section"
                                     class="d-flex align-items-center flex-grow-1 ps-0" t-ignore="true"
                                     role="complementary">
                                    <ul class="nav flex-column">
                                        <t t-foreach="ticket_link_section" t-as="ticket_link">
                                            <li class="nav-item">
                                                <a class="nav-link p-0" t-att-href="ticket_link['access_url']">
                                                    <t t-out="ticket_link['title']"/>
                                                </a>
                                            </li>
                                        </t>
                                    </ul>
                                </div>
                                <br/>
                                <br/>
                                <div t-if="ticket.user_ids or ticket.partner_id" class="d-flex flex-column gap-4">
                                    <!-- Assignees Section -->
                                    <div class="col-12" t-if="ticket.user_ids">
                                        <div class="border rounded-3 p-3 bg-light mb-3">
                                            <h5 class="flex-basis-100">
                                                <small class="text-muted">Assignees</small>
                                            </h5>
                                            <t t-foreach="ticket.user_ids" t-as="user">
                                                <div t-attf-class="o_portal_contact_details d-flex flex-column gap-2 {{ 'mb-3' if len(ticket.user_ids) > 1 else '' }}">
                                                    <div class="d-flex justify-content-start align-items-center gap-2">
                                                        <img class="o_avatar o_portal_contact_img rounded"
                                                             t-att-src="image_data_uri(user.avatar_128)"/>
                                                        <h6 class="mb-0" t-field="user.name"></h6>
                                                    </div>

                                                    <div>
                                                        <!-- Phone/Mobile -->
                                                        <t t-if="user.employee_id and (user.employee_id.mobile_phone or user.employee_id.work_phone)">
                                                            <div class="d-flex align-items-center">
                                                                <i class="fa fa-phone fa-fw me-1 text-muted"></i>
                                                                <a href="#"
                                                                   class="nav-link o_nav-link_secondary p-0 m-0 text-reset"
                                                                   style="line-height: 1;"
                                                                   t-att-data-phone="phone"
                                                                   onclick="openDialer(this); return false;">
                                                                    <span class="o_force_ltr" t-esc="phone"/>
                                                                </a>
                                                            </div>
                                                        </t>
                                                        <t t-elif="user.employee_id and user.employee_id.work_phone">
                                                            <div class="d-flex align-items-center">
                                                                <i class="fa fa-phone fa-fw me-1 text-muted"></i>
                                                                <a href="#"
                                                                   class="nav-link o_nav-link_secondary p-0 m-0 text-reset"
                                                                   style="line-height: 1;"
                                                                   t-att-data-phone="phone"
                                                                   onclick="openDialer(this); return false;">
                                                                    <span class="o_force_ltr" t-esc="phone"/>
                                                                </a>
                                                            </div>
                                                        </t>
                                                        <t t-else="">
                                                        </t>
                                                        <!-- Email -->
                                                        <br/>
                                                        <t t-if="user.partner_id and user.partner_id.email">
                                                            <i class="fa fa-envelope fa-fw me-1 text-muted"></i>
                                                            <a t-att-href="'mailto:' + user.partner_id.email">
                                                                <span t-esc="user.partner_id.email"/>
                                                            </a>
                                                        </t>
                                                        <t t-else="">
                                                        </t>
                                                    </div>
                                                    <script type="text/javascript">
                                                        function openDialer(el) {
                                                            let phone = el.dataset.phone || '';
                                                            // Remove spaces, dashes, parentheses
                                                            phone = phone.replace(/[\s\-()]/g, '');
                                                            if(phone) {
                                                                window.location.href = 'tel:' + phone;
                                                            } else {
                                                                alert('Phone number is not available');
                                                            }
                                                        }
                                                    </script>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="col-lg-9 col-md-8 ps-4">
                            <!-- Header -->
                            <div id="card_header" data-anchor="true">
                                <div class="row justify-content-between align-items-end mb-3">
                                    <div class="col-12 col-md-9">
                                        <div class="d-flex align-items-center gap-2">
                                            <h5 t-field="ticket.name" class="text-wrap text-break my-0"/>
                                        </div>
                                    </div>

                                    <!--Correct-->
                                    <div class="my-4 w-100 overflow-auto">
                                        <div class="d-flex align-items-stretch"
                                             style="white-space: nowrap; min-width: max-content; overflow-x: auto; -webkit-overflow-scrolling: touch;">
                                            <t t-set="last_stage_id" t-value="stages[-1].id"/>
                                            <t t-set="stage_index" t-value="0"/>

                                            <t t-foreach="stages" t-as="stage">
                                                <t t-set="is_active" t-value="stage.id == ticket.stage_id.id"/>
                                                <t t-set="bg_color" t-value="'#1255c3' if is_active else '#f8f9fa'"/>
                                                <t t-set="stroke_color"
                                                   t-value="'#1255c3' if is_active else '#dee2e6'"/>
                                                <t t-set="text_color" t-value="'#fff' if is_active else '#000'"/>
                                                <t t-set="is_first" t-value="stage_index == 0"/>
                                                <t t-set="is_last" t-value="stage.id == last_stage_id"/>

                                                <div class="position-relative d-inline-block"
                                                     t-attf-style="min-width:130px; margin-left: {{ '-16px' if not is_first else '0' }};">
                                                    <svg width="130" height="32" viewBox="0 0 140 32"
                                                         xmlns="http://www.w3.org/2000/svg">
                                                        <t t-if="is_first">
                                                            <polygon points="0,0 127,0 137,16 127,32 0,32"
                                                                     t-attf-fill="{{ bg_color }}"
                                                                     t-attf-stroke="{{ stroke_color }}"
                                                                     stroke-width="1"/>
                                                        </t>
                                                        <t t-elif="is_last">
                                                            <polygon points="0,0 10,16 0,32 127,32 127,0"
                                                                     t-attf-fill="{{ bg_color }}"
                                                                     t-attf-stroke="{{ stroke_color }}"
                                                                     stroke-width="1"/>
                                                        </t>
                                                        <t t-else="">
                                                            <polygon points="0,0 10,16 0,32 127,32 137,16 127,0"
                                                                     t-attf-fill="{{ bg_color }}"
                                                                     t-attf-stroke="{{ stroke_color }}"
                                                                     stroke-width="1"/>
                                                        </t>
                                                        <text x="50%" y="50%" dominant-baseline="middle"
                                                              text-anchor="middle"
                                                              t-attf-fill="{{ text_color }}"
                                                              font-size="13" font-family="sans-serif">
                                                            <t t-esc="stage.name"/>
                                                        </text>
                                                    </svg>
                                                </div>
                                                <t t-set="stage_index" t-value="stage_index + 1"/>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="card_body">
                                <div class="row mb-4 container">
                                    <div class="col-12 col-md-6 flex-grow-1">
                                        <div t-if="project_accessible" class="mb-2">
                                            <strong>Project:</strong>
                                            <a t-attf-href="/my/projects/#{ticket.project_id.id}"
                                               t-field="ticket.project_id"/>
                                        </div>
                                        <div t-if="ticket.sequence_fsm" class="mb-2">
                                            <strong>Ticket Number:</strong>
                                            <span t-field="ticket.sequence_fsm"/>
                                        </div>
                                        <div t-if="ticket.customer_product_id" class="mb-2">
                                            <strong>Product:</strong>
                                            <span t-field="ticket.customer_product_id"/>
                                        </div>
                                        <div t-if="ticket.planned_date_begin" class="mb-2">
                                            <strong>Expected Service Time:</strong>
                                            <span t-field="ticket.planned_date_begin"/>
                                        </div>
                                        <div t-if="ticket.create_date" class="mb-2">
                                            <strong>Creation Date-Time:</strong>
                                            <span t-field="ticket.create_date"/>
                                        </div>

                                        <div name="portal_my_ticket_allocated_hours" class="mb-2">
                                            <strong t-if="ticket.allocated_hours > 0">Allocated Time:</strong>
                                        </div>
                                        <div name="portal_my_ticket_call_type" class="mb-2">
                                            <t t-if="ticket.call_type">
                                                <strong>Call Type:</strong>
                                                <t t-esc="ticket.call_type.name or 'No Type'"/>
                                            </t>
                                        </div>

                                    </div>
                                    <t t-if="ticket.call_type.name == 'Chargeable' and service_charges">
                                        <div class="container mt-4">
                                            <div class="accordion-body p-0">
                                                <table class="table table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Service Charge Type</th>
                                                            <th>Amount</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="service_charges or [] " t-as="sc">
                                                            <tr>
                                                                <td>
                                                                    <t t-esc="sc.service_charge_type.display_name"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="'%s %.2f' % (ticket.currency_id.symbol if ticket.currency_id else '', sc.amount)"/>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                                <div class="mt-3">
                                                    <div>
                                                        <strong>Total Charge:</strong>
                                                        <t t-esc="'%s %.2f' % (ticket.currency_id.symbol if ticket.currency_id else '', total_charge)"/>
                                                    </div>
                                                    <div>
                                                        <strong>Paid Amount:</strong>
                                                        <t t-esc="'%s %.2f' % (ticket.currency_id.symbol if ticket.currency_id else '', ticket.paid_amount)"/>
                                                    </div>
                                                    <div>
                                                        <strong>Remaining Amount:</strong>
                                                        <t t-esc="'%s %.2f' % (ticket.currency_id.symbol if ticket.currency_id else '', ticket.remaining_amount)"/>
                                                    </div>
                                                    <div>
                                                        <strong>Payment Status:</strong>
                                                        <span class="badge bg-primary text-white">
                                                            <t t-esc="dict(ticket._fields['payment_status'].selection).get(ticket.payment_status, 'N/A')"/>
                                                        </span>
                                                    </div>
                                                    <div class="text-end mt-2">
                                                        <a role="button"
                                                           class="btn btn-primary"
                                                           data-bs-toggle="modal"
                                                           data-bs-target="#ticket_payment_modal">
                                                            Pay
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                    <div class="col-12 col-md-6 d-empty-none"
                                         name="portal_my_ticket_second_column"></div>
                                </div>
                                <div class="row">
                                    <!-- Description column -->
                                    <div t-if="not is_html_empty(ticket.description)"
                                         t-attf-class="col-12 mb-4 mb-md-0 {{'col-lg-6' if attachments else 'col-lg-12'}}">
                                        <hr class="mb-1"/>
                                        <div class="d-flex my-2">
                                            <h6>Description</h6>
                                        </div>
                                        <div class="py-1 px-2 bg-100 small table-responsive"
                                             t-field="ticket.description"/>
                                    </div>

                                    <!-- Attachments column -->
                                    <div t-if="attachments"
                                         t-attf-class="col-12 o_project_portal_attachments {{'col-lg-6' if not is_html_empty(ticket.description) else 'col-lg-12'}}">
                                        <hr class="mb-1 d-none d-lg-block"/>
                                        <strong class="d-block mb-2">Attachments</strong>

                                        <div class="row">
                                            <div t-attf-class="col {{'col-lg-6' if not is_html_empty(ticket.description) else 'col-lg-12'}}">
                                                <ul class="list-group">
                                                    <t t-foreach="attachments" t-as="attachment">
                                                        <li class="list-group-item d-flex align-items-center py-1 px-2">
                                                            <a t-att-download="attachment['name']"
                                                               t-att-href="attachment['url']"
                                                               class="d-flex align-items-center w-100">
                                                                <div class="oe_attachment_embedded o_image o_image_small me-2 me-lg-3"
                                                                     t-att-title="attachment['name']"
                                                                     t-att-data-mimetype="attachment['mimetype']"/>
                                                                <div class="oe_attachment_name text-truncate">
                                                                    <t t-esc="attachment['name']"/>
                                                                </div>
                                                            </a>
                                                        </li>
                                                    </t>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr/>
                            </div>
                            <div id="ticket_chat" data-anchor="true" class="mt-4">
                                <h4>Communication History</h4>
                                <t t-set="object" t-value="ticket"/>
                                <t t-set="message_ids"
                                   t-value="ticket.message_ids.sorted(key=lambda m: m.date, reverse=False)"/>
                                <t t-set="token" t-value="ticket.access_token"/>
                                <t t-call="portal.message_thread"/>
                            </div>
                        </div>
                    </div>
                </t>
                <t t-else="">
                    <div class="alert alert-warning mt-4">
                        This call was not found or is not assigned to you.
                    </div>
                </t>
            </div>


            <!--  Canceled Ticket if stage is New, Assigned and Planned  -->
            <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <form method="post" t-att-action="'/my/ticket/%s/cancel' % ticket.id">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <div class="modal-header">
                                <h5 class="modal-title" id="cancelModalLabel">Confirm Cancellation</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to cancel this ticket?
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Yes, Cancel</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!--   FeedBack Form if stage is Done, cancelled and resolved  -->
            <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div class="modal-header align-items-center">
                            <h5 class="modal-title mb-0 d-flex align-items-center" id="feedbackModalLabel">
                                <i class="fa fa-comments text-primary fs-4 me-2"></i>
                                Share Your Feedback
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <!-- Modal Body -->
                        <div class="modal-body">
                            <!-- Rating Stars -->
                            <div class="mb-3">
                                <label class="form-label d-block">Rating:</label>
                                <div id="rating-stars" class="text-warning fs-4">
                                    <i class="fa fa-star-o" data-value="1"></i>
                                    <i class="fa fa-star-o" data-value="2"></i>
                                    <i class="fa fa-star-o" data-value="3"></i>
                                    <i class="fa fa-star-o" data-value="4"></i>
                                    <i class="fa fa-star-o" data-value="5"></i>
                                </div>
                            </div>

                            <!-- Feedback Message -->
                            <div class="mb-3">
                                <label for="feedback-message" class="form-label">Additional Comment:</label>
                                <textarea class="form-control" id="feedback-message" rows="4"
                                          placeholder="Write your comment here..."></textarea>
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="submit-feedback"
                                    t-att-data-ticket-id="ticket.id">Submit
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Charge Payment -->
            <div class="modal fade" id="ticket_payment_modal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <header class="modal-header">
                            <h4 class="modal-title">Validate Payment</h4>
                            <button type="button" class="btn-close"
                                    data-bs-dismiss="modal"></button>
                        </header>
                        <main class="modal-body">
                            <p>
                                <span>By paying this service charge, I agree to the
                                    following terms:
                                </span>
                                <ul>
                                    <li>Accepted on behalf of:
                                        <b t-out="ticket.partner_id.name"/>
                                    </li>
                                    <li>For an amount of:
                                        <b t-out="total_charge"
                                           t-options="{'widget': 'monetary', 'display_currency': ticket.company_id.currency_id}"/>
                                    </li>
                                </ul>
                            </p>

                            <div class="mb-3">
                                <label for="payment_amount" class="form-label">Enter
                                    Payment Amount
                                </label>
                                <input type="number"
                                       id="payment_amount"
                                       name="payment_amount"
                                       min="1"
                                       t-att-max="ticket.remaining_amount"
                                       t-att-value="ticket.remaining_amount"
                                       class="form-control"/>
                            </div>
                            <div id="payment_method" class="text-start">
                                <h3 class="mb-3">Pay with</h3>
                                <t t-call="payment.form">
                                    <t t-set="transaction_route"
                                       t-value="'/my/ticket/%d/transaction' % ticket.id"/>
                                    <t t-set="landing_route"
                                       t-value="'/my/ticket/%d' % ticket.id"/>
                                </t>
                            </div>
                        </main>
                    </div>
                </div>
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const stars = document.querySelectorAll('#rating-stars i');
                    let selectedRating = 0;

                    // Handle star click
                    stars.forEach(star => {
                        star.addEventListener('click', function () {
                            const clickedRating = parseInt(this.getAttribute('data-value'));
                            const isAlreadyFilled = this.classList.contains('fa-star');

                            // Update selectedRating
                            selectedRating = isAlreadyFilled ? clickedRating - 1 : clickedRating;

                            // Refresh stars display
                            stars.forEach(s => {
                                const val = parseInt(s.getAttribute('data-value'));
                                if (val &lt;= selectedRating) {
                                    s.classList.remove('fa-star-o');
                                    s.classList.add('fa-star');
                                } else {
                                    s.classList.remove('fa-star');
                                    s.classList.add('fa-star-o');
                                }
                            });
                        });
                    });

                    // Submit feedback button handler
                    document.getElementById('submit-feedback').addEventListener('click', function () {
                        const message = document.getElementById('feedback-message').value.trim();
                        const ticketId = this.getAttribute('data-ticket-id');

                        fetch(`/my/ticket/${ticketId}/feedback`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                rating: selectedRating,
                                message: message
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            window.location.href = `/my/ticket/${ticketId}`;
                        })
                        .catch(err => {
                            console.error("Fetch failed:", err);
                            alert("Something went wrong submitting feedback.\n" + err.message);
                        });
                    });
                });
            </script>
        </t>
    </template>

    <!--    set record pager   -->
    <template id="record_pager" name="Portal Record Pager">
        <t t-if='prev_record or next_record'>
            <div class="record_pager btn-group my-2" role="group">
                <a role="button" t-att-class="'btn btn-light %s' % ('disabled' if not prev_record else '')"
                   t-att-href="prev_record or '#'">
                    <i class="oi oi-chevron-left" role="img" aria-label="Previous" title="Previous"></i>
                </a>
                <a role="button" t-att-class="'btn btn-light %s' % ('disabled' if not next_record else '')"
                   t-att-href="next_record or '#'">
                    <i class="oi oi-chevron-right" role="img" aria-label="Next" title="Next"></i>
                </a>
            </div>
        </t>
    </template>

    <template id="product_custom_page" name="Product Custom Page">
        <t t-call="portal.portal_layout">
            <script src="/web/static/lib/jquery/jquery.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>
            <div class="row mb-5">
                <div class="col-md-6 text-center">
                    <img id="zoom_image" t-if="product.image_1920"
                         t-att-src="'data:image/png;base64,' + product.image_1920.decode('utf-8')"
                         class="img img-fluid oe_unmovable product_detail_img w-100"/>
                </div>
                <div class="col-md-6">
                    <h2 t-esc="product.name"/>
                    <p class="h5 text-primary mb-2">₹
                        <t t-esc="'{:,.2f}'.format(product.list_price)"/>
                    </p>
                    <p>
                        <strong>Internal Reference:</strong>
                        <t t-esc="product.default_code or 'N/A'"/>
                    </p>
                    <div class="mt-3" t-if="product.description_sale">
                        <p t-raw="product.description_sale"/>
                    </div>

                    <div class="mt-4">
                        <a href="/contactus" class="btn">
                            <i class="fa fa-envelope me-1"/>
                            Contact Us
                        </a>
                    </div>
                </div>
            </div>

            <script>
                $(document).ready(function () {
                $("#zoom_image").elevateZoom({
                scrollZoom: true
                });
                });
            </script>
        </t>
    </template>

    <template id="portal_my_notifications" name="My Notifications">
        <t t-call="portal.portal_layout">
            <t t-call="portal.portal_searchbar">
                <t t-set="title" t-value="'Notifications'"/>
                <t t-set="searchbar_combined" t-value="searchbar_combined"/>
                <t t-set="search_in" t-value="search_in"/>
                <t t-set="filterby" t-value="filterby"/>
                <t t-set="groupby" t-value="groupby"/>
                <t t-set="search" t-value="search"/>
                <t t-set="default_url" t-value="default_url"/>
            </t>
            <t t-if="filterby == 'unread' or filterby == 'all'">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6></h6>
                    <a href="/my/notifications/read_all" class="btn btn-primary" id="readAllBtn">
                        All Read
                    </a>
                </div>
            </t>

            <t t-if="not notifications">
                <p class="alert alert-warning">There are no notifications for your account.</p>
            </t>
            <t t-elif="grouped_notifications">
                <div class="accordion" id="notificationAccordion">
                    <t t-foreach="grouped_notifications.items()" t-as="group">
                        <t t-set="title_name" t-value="group[0]"/>
                        <t t-set="title_notifications" t-value="group[1]"/>
                        <t t-set="title_id" t-value="'title-' + title_name.replace(' ', '_').replace('/', '_')"/>

                        <div class="accordion-item">
                            <h2 class="accordion-header" t-attf-id="heading-#{title_id}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        t-attf-data-bs-target="#collapse-#{title_id}" aria-expanded="false"
                                        t-attf-aria-controls="collapse-#{title_id}">
                                    <t t-esc="title_name or 'No Title'"/>
                                </button>
                            </h2>
                            <div t-attf-id="collapse-#{title_id}" class="accordion-collapse collapse"
                                 t-attf-aria-labelledby="heading-#{title_id}" data-bs-parent="#notificationAccordion">
                                <div class="accordion-body p-4">
                                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Message</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="title_notifications" t-as="note">
                                                    <tr t-attf-class="{'table-secondary': not note.is_read}">
                                                        <td class="wrap-text">
                                                            <a t-att-href="'/my/notifications/read/%d' % note.id"
                                                               t-att-title="note.title">
                                                                <t t-esc="note.title or 'No Title'"/>
                                                            </a>
                                                        </td>
                                                        <td class="wrap-text">
                                                            <t t-esc="note.message or ''"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="format_datetime(request.env, note.create_date, tz=request.env.user.tz or 'UTC', dt_format='dd/MM/yyyy HH:mm:ss')"/>
                                                        </td>
                                                        <td>
                                                            <span t-if="note.is_read"
                                                                  class="badge rounded-pill bg-success">Read
                                                            </span>
                                                            <span t-else=""
                                                                  class="badge rounded-pill bg-warning text-dark">Unread
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
            </t>

            <!-- Flat Table View -->
            <t t-elif="not groupby">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="notifications" t-as="note">
                                <tr t-attf-class="{'table-secondary': not note.is_read}">
                                    <td class="wrap-text">
                                        <a t-att-href="'/my/notifications/read/%d' % note.id" t-att-title="note.title">
                                            <t t-esc="note.title or 'No Title'"/>
                                        </a>
                                    </td>
                                    <td class="wrap-text">
                                        <t t-esc="note.message or ''"/>
                                    </td>
                                    <td>
                                        <t t-esc="format_datetime(request.env, note.create_date, tz=request.env.user.tz or 'UTC', dt_format='dd/MM/yyyy HH:mm:ss')"/>
                                    </td>
                                    <td>
                                        <span t-if="note.is_read" class="badge rounded-pill bg-success">Read</span>
                                        <span t-else="" class="badge rounded-pill bg-warning text-dark">Unread</span>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
            </t>
        </t>
    </template>

    <template id="product_grid_page" name="Product Grid Page">
        <t t-call="portal.portal_layout">
            <div class="container py-4">
                <!-- Search & Sort Row -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <form method="get" class="d-flex w-100">

                        <select name="sort" class="form-select me-2 w-auto rounded-pill" onchange="this.form.submit()">
                            <option value="date" t-att-selected="sort_by == 'date'">Newest</option>
                            <option value="price_asc" t-att-selected="sort_by == 'price_asc'">Price: Low to High
                            </option>
                            <option value="price_desc" t-att-selected="sort_by == 'price_desc'">Price: High to Low
                            </option>
                        </select>
                    </form>
                </div>

                <!-- Product Grid -->
                <div class="row g-4">
                    <t t-foreach="products" t-as="product">
                        <div class="col-6 col-sm-6 col-md-4 col-lg-3">

                            <a t-att-href="'/product/%s' % product.product_tmpl_id.id" class="text-decoration-none text-reset">
                                <div class="card border-0 shadow-sm h-100 rounded-0">
                                    <div class="oe_product_image position-relative overflow-hidden"
                                         style="aspect-ratio: 1 / 1; background: #f9f9f9;">
                                        <img t-if="product.image_1920"
                                             t-att-src="'data:image/png;base64,' + product.image_1920.decode('utf-8')"
                                             class="img-fluid w-100 h-100 object-fit-contain"/>
                                        <div t-else=""
                                             class="d-flex align-items-center justify-content-center w-100 h-100">
                                            <i class="fa fa-image fa-3x text-muted"/>
                                        </div>
                                    </div>
                                    <div class="card-body px-3 py-2">
                                        <div class="text-dark fw-semibold small" style="min-height: 20px;">
                                            <t t-esc="product.name"/>
                                        </div>
                                        <div class="text-muted small mt-1">
                                            ₹
                                            <t t-esc="'{:,.2f}'.format(product.list_price)"/>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </t>
                </div>

                <!-- Pagination -->
                <div class="text-center mt-4">
                    <ul class="pagination justify-content-center">
                        <li t-if="page > 1" class="page-item">
                            <a class="page-link"
                               t-att-href="'/products?page=%s&amp;q=%s&amp;sort=%s' % (page-1, search_term or '', sort_by or '')">
                                Previous
                            </a>
                        </li>
                        <t t-foreach="range(1, total_pages + 1)" t-as="pg">
                            <li t-attf-class="page-item #{'active' if pg == page else ''}">
                                <a class="page-link"
                                   t-att-href="'/products?page=%s&amp;q=%s&amp;sort=%s' % (pg, search_term or '', sort_by or '')">
                                    <t t-esc="pg"/>
                                </a>
                            </li>
                        </t>
                        <li t-if="page &lt; total_pages" class="page-item">
                            <a class="page-link"
                               t-att-href="'/products?page=%s&amp;q=%s&amp;sort=%s' % (page+1, search_term or '', sort_by or '')">
                                Next
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </t>
    </template>

    <template id="call_form_template" name="Create Ticket Form">
        <t t-call="portal.portal_layout">
            <div class="container">
                <div class="card shadow-sm p-4">
                    <!-- Button + input + video preview -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">Create New Ticket</h5>
                    </div>
                    <form class="customer_form" action="/ticket/submit" method="post">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                        <div class="mb-3">
                            <div id="priority-star" class="text-warning fs-4" style="cursor: pointer;">
                                <i class="fa fa-star-o" data-value="1"></i>
                            </div>
                            <input type="hidden" id="priority-value" name="priority" value="0"/>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                            const star = document.querySelector('#priority-star i');
                            const hiddenInput = document.getElementById('priority-value');

                            if (!star || !hiddenInput) return;

                            star.addEventListener('click', function () {
                            const isHigh = star.classList.contains('fa-star');

                            if (isHigh) {
                            star.classList.remove('fa-star');
                            star.classList.add('fa-star-o');
                            hiddenInput.value = 0;
                            } else {
                            star.classList.remove('fa-star-o');
                            star.classList.add('fa-star');
                            hiddenInput.value = 1;
                            }
                            });
                            });
                        </script>

                        <!-- Call Name Row -->
                        <div class="row mb-3">
                            <label for="name" class="col-sm-3 col-form-label">Call Name:</label>
                            <div class="col-sm-9">
                                <input type="text" name="name" class="form-control" required="required"
                                       placeholder="Call Name"/>
                            </div>
                        </div>
                        <!-- Product Dropdown -->
                        <div class="mb-3 row">
                            <label class="col-sm-3 col-form-label">Product:</label>
                            <div class="col-sm-9">
                                <select name="product_id" class="form-select" required="required">
                                    <option value="">-- Select Product --</option>
                                    <t t-if="products">
                                        <t t-foreach="products" t-as="product">
                                            <option t-att-value="product.id"
                                                    t-att-selected="product.id == default_product_id and 'selected' or None">
                                                <t t-esc="product.product_id.display_name"/>
                                            </option>
                                        </t>
                                    </t>
                                    <t t-if="not products">
                                        <option>No products available</option>
                                    </t>
                                </select>
                            </div>
                        </div>
                        <!-- Service Date (End Date Only) -->
                        <div class="row mb-3">
                            <label for="date_deadline" class="col-sm-3 col-form-label">Service Date:</label>
                            <div class="col-sm-9">
                                <!--  <input type="datetime-local" name="date_deadline" class="form-control" step="1"/> -->
                                <input type="text"
                                       name="date_deadline"
                                       class="form-control datetimepicker-input"
                                       data-widget="datetime-picker"
                                       data-widget-type="datetime"
                                       placeholder="Select Date and Time"
                                       required="required"/>
                            </div>
                        </div>
<!--                        <div class="row mb-3">-->
<!--                            <label for="planned_date_begin" class="col-sm-3 col-form-label">Service Start Date:</label>-->
<!--                            <div class="col-sm-9">-->
<!--                                <input type="text"-->
<!--                                       name="planned_date_begin"-->
<!--                                       class="form-control datetimepicker-input"-->
<!--                                       data-widget="datetime-picker"-->
<!--                                       data-widget-type="datetime"-->
<!--                                       placeholder="Select Start Date and Time"/>-->
<!--                            </div>-->
<!--                        </div>-->

<!--                        <div class="row mb-3">-->
<!--                            <label for="date_deadline" class="col-sm-3 col-form-label">Service End Date:</label>-->
<!--                            <div class="col-sm-9">-->
<!--                                <input type="text"-->
<!--                                       name="date_deadline"-->
<!--                                       class="form-control datetimepicker-input"-->
<!--                                       data-widget="datetime-picker"-->
<!--                                       data-widget-type="datetime"-->
<!--                                       placeholder="Select End Date and Time"/>-->
<!--                            </div>-->
<!--                        </div>-->

                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const form = document.querySelector('form.customer_form');
                                const dateInput = form.querySelector('input[name="date_deadline"]');

                                form.addEventListener('submit', function (event) {
                                    const inputVal = dateInput.value.trim();
                                    if (!inputVal) {
                                        // No date selected - allow submission or you can enforce required
                                        return;
                                    }

                                    // Parse the datetime string from your format: "dd/mm/yyyy HH:MM:SS"
                                    // We'll split manually because Date parsing is inconsistent
                                    function parseDateTime(str) {
                                        const parts = str.split(' ');
                                        if(parts.length !== 2) return null;
                                        const dateParts = parts[0].split('/');
                                        const timeParts = parts[1].split(':');
                                        if (dateParts.length !== 3 || timeParts.length !== 3) return null;

                                        // JS Date(year, monthIndex, day, hours, minutes, seconds)
                                        // monthIndex is 0-based
                                        return new Date(
                                            parseInt(dateParts[2], 10),
                                            parseInt(dateParts[1], 10) - 1,
                                            parseInt(dateParts[0], 10),
                                            parseInt(timeParts[0], 10),
                                            parseInt(timeParts[1], 10),
                                            parseInt(timeParts[2], 10)
                                        );
                                    }

                                    const selectedDate = parseDateTime(inputVal);
                                    if (!selectedDate) {
                                        alert('Invalid date format! Please use DD/MM/YYYY HH:MM:SS');
                                        event.preventDefault();
                                        return;
                                    }

                                    const now = new Date();
                                    const diffMs = selectedDate - now;
                                    const diffMinutes = diffMs / (1000 * 60);

                                    if (diffMinutes &lt; -10) {
                                        alert('Please select current or future date/time .');
                                        event.preventDefault();
                                        return;
                                    }
                                });
                            });
                        </script>
                        <div class="row mb-3">
                            <label for="complaint_type_id" class="col-sm-3 col-form-label">Complaint Type:</label>
                            <div class="col-sm-9">
                                <select id="complaint-select"
                                        name="complaint_type_ids"
                                        class="form-select select_box_test" multiple="multiple" placeholder="Select Complaint Type">
                                    <t t-foreach="complaint_types" t-as="ctype">
                                        <option t-att-value="ctype.id">
                                            <t t-esc="ctype.name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="reason_code_id" class="col-sm-3 col-form-label">Reason code</label>
                            <div class="col-sm-9">
                                <select name="reason_code_id" id="reason-code-select"
                                        class="form-select select_box_test" multiple="multiple" placeholder="Select Reason Code">
                                    <option value=""></option>
                                </select>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">Submit Ticket</button>
                            <a href="/my/view" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </t>
    </template>

    <template id="product_warning_template" name="Product Not Available">
        <t t-call="portal.portal_layout">
            <div class="container mt-5">
                <div class="alert alert-danger">
                    <strong>Warning!</strong>
                        Please contact on support number; asset not added
                </div>
            </div>
        </t>
    </template>


    <template id="call_thank_you_template" name="Call Thank You">
        <t t-call="portal.portal_layout">
            <div class="container mt-4">
                <h2>Thank you!</h2>
                <p>Your ticket has been submitted successfully.</p>

                <t t-if="is_holiday">
                    <div class="alert alert-warning mt-3">
                        Today is a company holiday, but your ticket has been submitted successfully.
                    </div>
                </t>
            </div>
        </t>
    </template>

    <template id="reschedule_form_template" name="Reschedule Ticket">
        <t t-call="portal.portal_layout">
            <div class="container mt-4">
                <div class="card shadow-sm p-4">
                    <h4 class="mb-4">Reschedule Ticket</h4>
                    <form action="/my/ticket/reschedule/submit" method="post">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <input type="hidden" name="ticket_id" t-att-value="ticket.id"/>

                        <!-- Call Name -->
                        <div class="row mb-3">
                            <label for="name" class="col-sm-3 col-form-label">Call Name:</label>
                            <div class="col-sm-9">
                                <input type="text" name="name" class="form-control"
                                       t-att-value="ticket.name" required="required"/>
                            </div>
                        </div>

                        <!-- Service Date (date_deadline) -->
                        <div class="row mb-3">
                            <label for="date_deadline" class="col-sm-3 col-form-label">Service Date:</label>
                            <div class="col-sm-9">

                                <input type="date" name="date_deadline" class="form-control"
                                       t-att-value="ticket.date_deadline and ticket.date_deadline.strftime('%d/%m/%Y') or ''"/>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">Update</button>
                            <a t-att-href="'/my/ticket/%s' % ticket.id" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </t>
    </template>
</odoo>
